<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord - Propre Eco</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .card-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
}

.card-buttons .btn {
    font-size: 0.85rem;
    padding: 0.5rem 1rem;
        max-width: fit-content;

}

/* Animations pour les notifications */
@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideOutRight {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(100%);
    }
}
    </style>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <i class="fas fa-leaf"></i>
                Propre Eco Assistant
            </a>

            <button class="nav-toggle" aria-label="Menu">
                <i class="fas fa-bars"></i>
            </button>

            <nav>
                <ul class="nav-menu">
                    <li><a href="index.html"><i class="fas fa-home"></i> Accueil</a></li>
                    <li><a href="signaler.html"><i class="fas fa-exclamation-triangle"></i> Signaler</a></li>
                    <li class="nav-signalements"><a href="voir.html"><i class="fas fa-eye"></i> Signalements <span
                                id="notifBadge" class="notif-badge loading">⟳</span></a></li>
                    <li><a href="Feuilles.html"><i class="fas fa-file-alt"></i> Feuilles</a></li>
                    <li><a href="dashbord.html"><i class="fas fa-columns"></i> Tableau de bord</a></li>
                    <li><a href="pointeuse.html"><i class="fas fa-clock"></i> Pointeuse</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">

        <!-- Section Code d'accès -->
        <section class="section" id="gate">
            <h2 class="section-title">
                <i class="fas fa-shield-alt"></i>
                Accès sécurisé
            </h2>

            <form id="code-form" class="access-form">
                <div class="input-group">
                    <input id="code-input" type="password" class="form-input" placeholder="Code de sécurité" required />
                </div>
                <button type="submit" class="btn">
                    <i class="fas fa-unlock"></i>
                    Accéder au tableau de bord
                </button>
                <div id="status" class="status"></div>
            </form>
        </section>

        <!-- Section Dashboard -->
        <div class="dashboard-container" id="dashboard" style="display: none;     margin-top: 1rem;
">


            <!-- Derniers signalements -->
            <section class="card">
                <header class="card-header">
                    <div>
                        <h2 class="card-title">
                            <i class="fas fa-exclamation-circle"></i>
                            Derniers signalements
                        </h2>
                        <p class="card-subtitle">
                            <i class="fas fa-clock"></i>
                            Problèmes récemment signalés
                        </p>
                    </div>
                    <button class="btn" onclick="window.location.href='voir.html'" style="width: auto;">
                        <i class="fas fa-list"></i>
                        Voir tous les signalements
                    </button>
                </header>

                <div class="table-container">
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-building"></i> Copropriété</th>
                                    <th><i class="fas fa-comment"></i> Description</th>
                                    <th><i class="fas fa-user"></i> Employé</th>
                                    <th><i class="fas fa-images"></i> Images</th>
                                    <th><i class="fas fa-calendar"></i> Date</th>
                                </tr>
                            </thead>
                            <tbody id="signalementsBody">
                                <tr>
                                    <td colspan="5" class="loading">
                                        <i class="fas fa-spinner"></i>
                                        Chargement des signalements...
                                    </td>
                                </tr>

                            </tbody>
                        </table>
                    </div>
                </div>
            </section>


            <!-- Dernières feuilles de passage -->
            <section class="card">
                <header class="card-header">
                    <div>
                        <h2 class="card-title">
                            <i class="fas fa-file-signature"></i>
                            Feuilles de passage
                        </h2>
                        <p class="card-subtitle">
                            <i class="fas fa-clock"></i>
                            Passages récents validés
                        </p>
                    </div>
              <div class="card-buttons">
    <button class="btn btn-secondary" onclick="window.open('https://dylan-propreeco.imgbb.com/')">
        <i class="fas fa-external-link-alt"></i>
        Gérer sur ImgBB
    </button>
    <button id="downloadAllFeuilles" class="btn" title="Télécharger toutes les feuilles en ZIP">
        <i class="fas fa-download"></i>
        Télécharger tout
    </button>
    <button id="deleteAllFeuilles" class="btn btn-danger" title="Supprimer toutes les feuilles (ImgBB + Firebase)">
        <i class="fas fa-trash-alt"></i>
        Tout supprimer
    </button>
</div>
                </header>

                <div class="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Les photos sont supprimées automatiquement tous les mois</span>
                </div>

                <div class="table-container">
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-building"></i> Copropriété</th>
                                    <th><i class="fas fa-camera"></i> Photo</th>
                                    <th><i class="fas fa-calendar"></i> Date</th>
                                </tr>
                            </thead>
                            <tbody id="feuillesBody">
                                <tr>
                                    <td colspan="3" class="loading">
                                        <i class="fas fa-spinner"></i>
                                        Chargement des feuilles...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>


            <!-- Section Agenda des travaux  -->
            <section class="card">
                <header class="card-header">
                    <div>
                        <h2 class="card-title">
                            <i class="fas fa-calendar-alt"></i>
                            Agenda des travaux
                        </h2>
                        <p class="card-subtitle">
                            <i class="fas fa-tasks"></i>
                            Planification des prochains travaux
                        </p>
                    </div>
                    <div class="card-buttons" style="margin: auto;">
                        <button class="btn btn-primary" onclick="addGoogleEvent()" style="margin-bottom:1rem">
                            <i class="fas fa-plus"></i>
                            Ajouter un travail
                        </button>
                        <!-- <button class="btn btn-agenda" onclick="openGoogleCalendar()">
                            <i class="fas fa-external-link-alt"></i>
                            Ouvrir dans Google
                        </button> -->
                    </div>
                </header>

                <div class="google-calendar-container">
                    <iframe
                        src="https://calendar.google.com/calendar/embed?src=dylan.propre.eco%40gmail.com&ctz=Europe%2FParis"
                        style="border: 0; width: 100%; height: 600px;" frameborder="0" scrolling="no">
                    </iframe>
                </div>
            </section>
        </div>
    </div>



    <!-- Scripts Firebase -->
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBzXEN0e-4dgh9NVVF7JGzpKtJrPnuzo0Y",
            authDomain: "copro-256d7.firebaseapp.com",
            projectId: "copro-256d7",
            storageBucket: "copro-256d7.appspot.com",
            messagingSenderId: "665588381388",
            appId: "1:665588381388:web:a0567533ff1a62407db469",
            measurementId: "G-Y7YNZDDCTD"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const status = document.getElementById('status');

        // État d'authentification global
        window.isAuthenticated = false;



        // Navigation mobile
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButton = document.querySelector('.nav-toggle');
            const menu = document.querySelector('.nav-menu');

            if (toggleButton && menu) {
                toggleButton.addEventListener('click', () => {
                    menu.classList.toggle('open');
                });

                document.querySelectorAll('.nav-menu a').forEach(link => {
                    link.addEventListener('click', () => {
                        menu.classList.remove('open');
                    });
                });
            }
        });
        function addGoogleEvent() {
            const today = new Date();
            const dateStr = today.getFullYear() +
                String(today.getMonth() + 1).padStart(2, '0') +
                String(today.getDate()).padStart(2, '0');

            const url = `https://calendar.google.com/calendar/u/0/r/eventedit?dates=${dateStr}/${dateStr}&text=Travaux&location=&details=Description%20des%20travaux&ctz=Europe/Paris&src=dylan.propre.eco@gmail.com`;
            window.open(url, '_blank');
        }
        // Affichage des messages de statut
        function showStatus(message, type) {
            status.className = `status ${type}`;
            status.style.display = 'block';

            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-times-circle'
            };

            status.innerHTML = `
                <i class="${icons[type]}"></i>
                ${message}
            `;

            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }
        function openGoogleCalendar() {
            window.open('https://calendar.google.com/calendar/u/0?cid=ZHlsYW4ucHJvcHJlLmVjb0BnbWFpbC5jb20', '_blank');
        }
        // Authentification avec gestion de l'affichage du badge
        document.getElementById('code-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const code = document.getElementById('code-input').value;
            const submitBtn = e.target.querySelector('button');

            if (code === "110389") {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authentification...';
                submitBtn.disabled = true;

                setTimeout(() => {
                    // Marquer comme authentifié
                    window.isAuthenticated = true;

                    // Afficher l'élément de navigation des signalements
                    const navSignalements = document.querySelector('.nav-signalements');
                    if (navSignalements) {
                        navSignalements.classList.add('authenticated');
                    }

                    document.getElementById('gate').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'grid';
                    showStatus('Accès autorisé', 'success');
                    loadSignalements();
                    loadFeuilles();
                }, 1000);
            } else {
                showStatus('Code de sécurité incorrect', 'error');
                document.getElementById('code-input').focus();

                // Animation d'erreur
                const form = document.getElementById('code-form');
                form.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    form.style.animation = '';
                }, 500);
            }
        });


        // Chargement des signalements avec gestion d'erreur améliorée
        async function loadSignalements() {
            const tbody = document.getElementById('signalementsBody');

            try {
                const snapshot = await db.collection('signalements')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();

                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem; color: #6b7280;">
                                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                Aucun signalement trouvé
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = '';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    let imgHTML = '';

                    if (data.images && data.images.length > 0) {
                        imgHTML = data.images.map(img => `
                            <img src="${img.url}" 
                                 class="thumb" 
                                 alt="Image du signalement"
                                 onclick="window.open('${img.url}', '_blank')"
                                 loading="lazy">
                        `).join('');
                    } else {
                        imgHTML = '<span style="color: #6b7280; font-style: italic;">Aucune image</span>';
                    }

                    const date = data.createdAt ?
                        data.createdAt.toDate().toLocaleString('fr-FR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 'Date inconnue';

                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${data.copro || 'Non spécifiée'}</strong></td>
                            <td>${data.description || 'Pas de description'}</td>
                            <td>${data.employee || 'Non spécifié'}</td>
                            <td>${imgHTML}</td>
                            <td>${date}</td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error('Erreur lors du chargement des signalements:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            Erreur de chargement des signalements
                        </td>
                    </tr>
                `;
            }
        }

        // Chargement des feuilles de passage avec gestion d'erreur améliorée
        async function loadFeuilles() {
            const tbody = document.getElementById("feuillesBody");

            try {
                const snapshot = await db.collection("feuilles_passage")
                    .orderBy("createdAt", "desc")
                    .limit(20)
                    .get();

                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="3" style="text-align: center; padding: 2rem; color: #6b7280;">
                                <i class="fas fa-file-alt" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                Aucune feuille de passage trouvée
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = "";

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const tr = document.createElement("tr");

                    // Copropriété
                    const tdCopro = document.createElement("td");
                    tdCopro.innerHTML = `<strong>${data.copro || "Non spécifiée"}</strong>`;
                    tr.appendChild(tdCopro);

                    // Photo
                    const tdPhoto = document.createElement("td");
                    if (data.url) {
                        const img = document.createElement("img");
                        img.src = data.url;
                        img.className = "thumb";
                        img.alt = "Feuille signée";
                        img.loading = "lazy";
                        img.onclick = () => window.open(data.url, "_blank");
                        tdPhoto.appendChild(img);
                    } else {
                        tdPhoto.innerHTML = '<span style="color: #6b7280; font-style: italic;">Pas de photo</span>';
                    }
                    tr.appendChild(tdPhoto);

                    // Date
                    const tdDate = document.createElement("td");
                    const date = data.createdAt?.toDate?.() || new Date();
                    tdDate.textContent = date.toLocaleString("fr-FR", {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    tr.appendChild(tdDate);

                    tbody.appendChild(tr);
                });

            } catch (error) {
                console.error('Erreur lors du chargement des feuilles:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 2rem; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            Erreur de chargement des feuilles
                        </td>
                    </tr>
                `;
            }
        }

        // Fermer le modal avec Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('noteModal').classList.contains('active')) {
                closeNoteModal();
            }
        });
    </script>

    <!-- Badge script corrigé -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBzXEN0e-4dgh9NVVF7JGzpKtJrPnuzo0Y",
            authDomain: "copro-256d7.firebaseapp.com",
            projectId: "copro-256d7",
            storageBucket: "copro-256d7.firebasestorage.app",
            messagingSenderId: "665588381388",
            appId: "1:665588381388:web:a0567533ff1a62407db469",
            measurementId: "G-Y7YNZDDCTD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const notifBadge = document.getElementById('notifBadge');

        // Service de notification corrigé
        class NotificationService {
            constructor() {
                this.init();
            }

            async updateNotificationBadge() {
                try {
                    const q = query(collection(db, "signalements"), orderBy("createdAt", "desc"));
                    const querySnapshot = await getDocs(q);
                    const count = querySnapshot.size;

                    if (notifBadge) {
                        notifBadge.textContent = count;
                        notifBadge.classList.remove('loading');

                        // Animation plus douce
                        if (count > 0) {
                            notifBadge.classList.add('updated');
                            setTimeout(() => {
                                notifBadge.classList.remove('updated');
                            }, 600);
                        }
                    }
                } catch (error) {
                    console.error("Erreur lors de la récupération du nombre de signalements:", error);
                    if (notifBadge) {
                        notifBadge.textContent = "!";
                        notifBadge.classList.remove('loading');
                    }
                }
            }

            setupRealTimeListener() {
                const q = query(collection(db, "signalements"), orderBy("createdAt", "desc"));
                onSnapshot(q, (snapshot) => {
                    const count = snapshot.size;
                    if (notifBadge) {
                        notifBadge.textContent = count;
                        notifBadge.classList.remove('loading');

                        // Animation plus douce uniquement si authentifié
                        if (count > 0 && window.isAuthenticated) {
                            notifBadge.classList.add('updated');
                            setTimeout(() => {
                                notifBadge.classList.remove('updated');
                            }, 600);
                        }
                    }
                }, (error) => {
                    console.error("Erreur lors de l'écoute des signalements:", error);
                    if (notifBadge) {
                        notifBadge.textContent = "!";
                        notifBadge.classList.remove('loading');
                    }
                });
            }

            init() {
                document.addEventListener('DOMContentLoaded', () => {
                    // Attendre un peu avant de charger le badge pour éviter le flash
                    setTimeout(() => {
                        this.updateNotificationBadge();
                        this.setupRealTimeListener();
                    }, 500);
                });
            }
        }

        new NotificationService();

        // === FONCTIONNALITÉS FEUILLES DE PASSAGE ===

// Fonction utilitaire pour afficher des notifications
function showFastNotification(message, type = 'info', duration = 4000) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' :
            type === 'warning' ? 'linear-gradient(135deg, #f59e0b, #d97706)' :
                type === 'error' ? 'linear-gradient(135deg, #ef4444, #dc2626)' :
                    'linear-gradient(135deg, #3b82f6, #2563eb)'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        z-index: 1000;
        font-weight: 600;
        animation: slideInRight 0.3s ease-out;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        max-width: 400px;
        font-size: 0.9rem;
    `;

    const icons = {
        success: 'fas fa-check-circle',
        warning: 'fas fa-exclamation-triangle',
        error: 'fas fa-times-circle',
        info: 'fas fa-info-circle'
    };

    notification.innerHTML = `<i class="${icons[type]}"></i> ${message}`;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
        setTimeout(() => notification.remove(), 300);
    }, duration);
}

// Télécharger toutes les feuilles de passage
async function downloadAllFeuilles() {
    const downloadBtn = document.getElementById('downloadAllFeuilles');
    const originalContent = downloadBtn.innerHTML;
    
    try {
        downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Téléchargement...';
        downloadBtn.disabled = true;

        showFastNotification('Récupération des feuilles...', 'info', 2000);

        // UTILISER FIREBASE V8 COMPAT
        const snapshot = await firebase.firestore().collection('feuilles_passage').orderBy('createdAt', 'desc').get();
        const feuilles = [];
        
        snapshot.forEach(doc => {
            feuilles.push({
                id: doc.id,
                ...doc.data()
            });
        });

        if (feuilles.length === 0) {
            showFastNotification('Aucune feuille à télécharger', 'warning');
            return;
        }

        showFastNotification(`Création de l'archive de ${feuilles.length} feuilles...`, 'info', 3000);

        const zip = new JSZip();
        let processed = 0;
        let successful = 0;

        // Traiter chaque feuille
        for (const feuille of feuilles) {
            try {
                if (feuille.url) {
                    // Télécharger l'image
                    const response = await fetch(feuille.url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const blob = await response.blob();
                    
                    // Créer un nom de fichier unique
                    const date = feuille.createdAt ? 
                        feuille.createdAt.toDate().toISOString().slice(0, 19).replace(/:/g, '-') : 
                        'date_inconnue';
                    const copro = (feuille.copro || 'copro_inconnue').replace(/[^a-zA-Z0-9]/g, '_');
                    const extension = feuille.url.split('.').pop().split('?')[0] || 'jpg';
                    const filename = `${date}_${copro}_${feuille.id}.${extension}`;

                    // Ajouter au ZIP
                    zip.file(filename, blob);
                    successful++;
                }
                processed++;

                // Mettre à jour le texte du bouton avec le progrès
                downloadBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${processed}/${feuilles.length}`;

            } catch (imageError) {
                console.error(`Erreur téléchargement image ${feuille.id}:`, imageError);
                processed++;
            }
        }

        downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération ZIP...';

        // Générer le ZIP
        const zipBlob = await zip.generateAsync({
            type: "blob",
            compression: "DEFLATE",
            compressionOptions: { level: 6 }
        });

        // Télécharger le fichier
        const url = window.URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `feuilles_passage_${new Date().toISOString().slice(0, 10)}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showFastNotification(`Archive téléchargée : ${successful}/${feuilles.length} feuilles`, 'success', 5000);

    } catch (error) {
        console.error('Erreur téléchargement:', error);
        showFastNotification('Erreur lors du téléchargement', 'error');
    } finally {
        downloadBtn.innerHTML = originalContent;
        downloadBtn.disabled = false;
    }
}

// Supprimer toutes les feuilles de passage
async function deleteAllFeuilles() {
    try {
        // Vérifier d'abord le nombre de feuilles
        const countSnapshot = await firebase.firestore().collection('feuilles_passage').get();
        const count = countSnapshot.size;
        
        if (count === 0) {
            showFastNotification('Aucune feuille à supprimer', 'warning');
            return;
        }

        // Triple confirmation
        if (!confirm(`⚠️ ATTENTION ⚠️\n\nVous allez supprimer définitivement ${count} feuilles de passage.\n\nCette action supprimera :\n• Toutes les images sur ImgBB\n• Toutes les données sur Firebase\n\nCette action est IRRÉVERSIBLE !\n\nContinuer ?`)) {
            return;
        }

        if (!confirm(`Dernière confirmation !\n\nÊtes-vous absolument certain de vouloir supprimer ${count} feuilles définitivement ?`)) {
            return;
        }

        const confirmation = prompt('Tapez "SUPPRIMER" pour confirmer la suppression définitive :');
        if (confirmation !== 'SUPPRIMER') {
            showFastNotification('Suppression annulée', 'warning');
            return;
        }

        const deleteBtn = document.getElementById('deleteAllFeuilles');
        const originalContent = deleteBtn.innerHTML;
        
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Suppression...';
        deleteBtn.disabled = true;

        showFastNotification('Suppression en cours...', 'info', 3000);

        // Récupérer toutes les feuilles
        const snapshot = await firebase.firestore().collection('feuilles_passage').get();

        let processed = 0;
        let deletedImages = 0;
        let deletedDocs = 0;

        // Supprimer chaque feuille
        for (const doc of snapshot.docs) {
            const data = doc.data();
            
            try {
                // Supprimer l'image d'ImgBB si elle existe
                if (data.deleteUrl) {
                    try {
                        const response = await fetch(data.deleteUrl);
                        if (response.ok) {
                            deletedImages++;
                        }
                    } catch (imgError) {
                        console.error(`Erreur suppression ImgBB ${doc.id}:`, imgError);
                    }
                }

                // Supprimer le document Firebase
                await doc.ref.delete();
                deletedDocs++;

            } catch (docError) {
                console.error(`Erreur suppression document ${doc.id}:`, docError);
            }

            processed++;
            // Mettre à jour le progrès
            deleteBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${processed}/${snapshot.docs.length}`;
        }

        // Recharger les feuilles dans le tableau
        await loadFeuilles();

        showFastNotification(`Suppression terminée : ${deletedDocs} documents et ${deletedImages} images supprimés`, 'success', 6000);

    } catch (error) {
        console.error('Erreur suppression:', error);
        showFastNotification('Erreur lors de la suppression', 'error');
    } finally {
        const deleteBtn = document.getElementById('deleteAllFeuilles');
        deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Tout supprimer';
        deleteBtn.disabled = false;
    }
}
// Event listeners pour les nouveaux boutons
document.addEventListener('DOMContentLoaded', function() {
    // Attendre que les éléments soient créés
    setTimeout(() => {
        const downloadBtn = document.getElementById('downloadAllFeuilles');
        const deleteBtn = document.getElementById('deleteAllFeuilles');
        
        if (downloadBtn) {
            downloadBtn.addEventListener('click', downloadAllFeuilles);
        }
        
        if (deleteBtn) {
            deleteBtn.addEventListener('click', deleteAllFeuilles);
        }
    }, 1000);
});
    </script>

</body>

</html>