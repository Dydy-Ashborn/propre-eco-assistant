<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord - Propre Eco</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .btn-small {
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;

            cursor: pointer;
            transition: 0.2s;
        }

        .btn-small:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
        }

        .btn-small.active {
            background: #3b82f6;
            color: white;
        }

        .btn-small {
            width: 5px;

        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-top: 1px solid #e2e8f0;
            margin-top: 1rem;
        }

        .pagination-info {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .pagination-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f8fafc;
            border-color: #3b82f6;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f9fafb;
        }

        .pagination-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .page-select {
            padding: 0.4rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.875rem;
            margin: 0 0.5rem;
        }

        @media (max-width: 768px) {
            .pagination-container {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }

        .filters-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-input {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: white;
        }

        .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .filter-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .filter-btn-secondary {
            background-color: rgb(233, 24, 24);
            color: white;
            border: 1px solid #e2e8f0;
        }

        .filter-btn-secondary:hover {
            background-color: rgb(184, 15, 15);
        }

        @media (max-width: 768px) {
            .filters-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .filter-buttons {
                justify-content: center;
            }
        }

        .card-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .card-buttons .btn {
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
            max-width: fit-content;
        }

        /* Animations pour les notifications */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }

            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <i class="fas fa-leaf"></i>
                Propre Eco Assistant
            </a>

            <button class="nav-toggle" aria-label="Menu">
                <i class="fas fa-bars"></i>
            </button>

            <nav>
                <ul class="nav-menu">
                    <li><a href="index.html"><i class="fas fa-home"></i> Accueil</a></li>
                    <li><a href="signaler.html"><i class="fas fa-exclamation-triangle"></i> Signaler</a></li>
                    <li class="nav-signalements"><a href="voir.html"><i class="fas fa-eye"></i> Signalements <span
                                id="notifBadge" class="notif-badge loading">⟳</span></a></li>
                    <li><a href="Feuilles.html"><i class="fas fa-file-alt"></i> Feuilles</a></li>
                    <li><a href="dashbord.html"><i class="fas fa-columns"></i> Tableau de bord</a></li>
                    <li><a href="pointeuse.html"><i class="fas fa-clock"></i> Pointeuse</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">

        <!-- Section Code d'accès -->
        <section class="section" id="gate">
            <h2 class="section-title">
                <i class="fas fa-shield-alt"></i>
                Accès sécurisé
            </h2>

            <form id="code-form" class="access-form">
                <div class="input-group">
                    <input id="code-input" type="password" class="form-input" placeholder="Code de sécurité" required />
                </div>
                <button type="submit" class="btn">
                    <i class="fas fa-unlock"></i>
                    Accéder au tableau de bord
                </button>
                <div id="status" class="status"></div>
            </form>
        </section>

        <!-- Section Dashboard -->
        <div class="dashboard-container" id="dashboard" style="display: none;     margin-top: 1rem;">


            <!-- Derniers signalements -->
            <section class="card">
                <header class="card-header">
                    <div>
                        <h2 class="card-title">
                            <i class="fas fa-exclamation-circle"></i>
                            Derniers signalements
                        </h2>
                        <p class="card-subtitle">
                            <i class="fas fa-clock"></i>
                            Problèmes récemment signalés
                        </p>
                    </div>
                    <button class="btn" onclick="window.location.href='voir.html'" style="width: auto;">
                        <i class="fas fa-list"></i>
                        Voir tous les signalements
                    </button>
                </header>

                <div class="table-container">
                    <!-- FILTRES POUR SIGNALMENTS -->
                    <div class="filters-container" id="signalementsFilters">
                        <div class="filter-group">
                            <label for="filterCopro" class="filter-label">
                                <i class="fas fa-building"></i>
                                Filtrer par copropriété
                            </label>
                            <input type="text" id="filterCopro" class="filter-input"
                                placeholder="Nom de la copropriété...">
                        </div>

                        <div class="filter-group">
                            <label for="filterSignalDate" class="filter-label">
                                <i class="fas fa-calendar-alt"></i>
                                Filtrer par date
                            </label>
                            <input type="date" id="filterSignalDate" class="filter-input">
                        </div>

                        <div class="filter-group">
                            <div class="filter-buttons">
                                <!-- <button id="applySignalFilters" class="filter-btn filter-btn-primary">
                                    <i class="fas fa-search"></i> Rechercher
                                </button> -->
                                <button id="clearSignalFilters" class="filter-btn filter-btn-secondary">
                                    <i class="fas fa-times"></i> Effacer
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-building"></i> Copropriété</th>
                                    <th><i class="fas fa-comment"></i> Description</th>
                                    <th><i class="fas fa-user"></i> Employé</th>
                                    <th><i class="fas fa-images"></i> Images</th>
                                    <th><i class="fas fa-calendar"></i> Date</th>
                                </tr>
                            </thead>
                            <tbody id="signalementsBody">
                                <tr>
                                    <td colspan="5" class="loading">
                                        <i class="fas fa-spinner"></i>
                                        Chargement des signalements...
                                    </td>
                                </tr>

                            </tbody>
                        </table>
                    </div>

                </div>
                <div id="signalementsPaginationControls" style="text-align:center; margin-top:1rem;"></div>

            </section>


            <!-- Dernières feuilles de passage -->
            <section class="card">
                <header class="card-header">
                    <div>
                        <h2 class="card-title">
                            <i class="fas fa-file-signature"></i>
                            Feuilles de passage
                        </h2>
                        <p class="card-subtitle">
                            <i class="fas fa-clock"></i>
                            Passages récents validés
                        </p>
                    </div>
                    <div class="card-buttons">
                        <button class="btn btn-secondary" onclick="window.open('https://dylan-propreeco.imgbb.com/')">
                            <i class="fas fa-external-link-alt"></i>
                            Gérer sur ImgBB
                        </button>
                        <button id="downloadAllFeuilles" class="btn" title="Télécharger toutes les feuilles en ZIP">
                            <i class="fas fa-download"></i>
                            Télécharger tout
                        </button>
                        <button id="deleteAllFeuilles" class="btn btn-danger"
                            title="Supprimer toutes les feuilles (ImgBB + Firebase)">
                            <i class="fas fa-trash-alt"></i>
                            Tout supprimer
                        </button>
                    </div>
                </header>

                <div class="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Pensez à télécharger et supprimer toutes les photos une fois par mois.</span>
                </div>

                <!-- FILTRES MAINTENANT À L'INTÉRIEUR DE LA CARD -->
                <div class="filters-container">
                    <div class="filter-group">
                        <label for="filterName" class="filter-label">
                            <i class="fas fa-user"></i>
                            Rechercher par nom
                        </label>
                        <input type="text" id="filterName" class="filter-input" placeholder="Nom...">
                    </div>

                    <div class="filter-group">
                        <label for="filterDate" class="filter-label">
                            <i class="fas fa-calendar-alt"></i>
                            Filtrer par date
                        </label>
                        <input type="date" id="filterDate" class="filter-input">
                    </div>

                    <div class="filter-group">
                        <div class="filter-buttons">
                            <!-- <button id="applyFilters" class="filter-btn filter-btn-primary">
                                <i class="fas fa-search"></i>
                                Rechercher
                            </button> -->
                            <button id="clearFilters" class="filter-btn filter-btn-secondary">
                                <i class="fas fa-times"></i>
                                Effacer
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-building"></i> Copropriété</th>
                                    <th><i class="fas fa-user"></i> Agent</th>
                                    <th><i class="fas fa-camera"></i> Photo</th>
                                    <th><i class="fas fa-calendar"></i> Date</th>
                                </tr>
                            </thead>
                            <tbody id="feuillesBody">
                                <tr>
                                    <td colspan="4" class="loading">
                                        <i class="fas fa-spinner"></i>
                                        Chargement des feuilles...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>




            <!-- Section Agenda des travaux  -->
            <section class="card">
                <header class="card-header">
                    <div>
                        <h2 class="card-title">
                            <i class="fas fa-calendar-alt"></i>
                            Agenda des travaux
                        </h2>
                        <p class="card-subtitle">
                            <i class="fas fa-tasks"></i>
                            Planification des prochains travaux
                        </p>
                    </div>
                    <div class="card-buttons" style="margin: auto;">
                        <button class="btn btn-primary" onclick="addGoogleEvent()" style="margin-bottom:1rem">
                            <i class="fas fa-plus"></i>
                            Ajouter un travail
                        </button>
                        <!-- <button class="btn btn-agenda" onclick="openGoogleCalendar()">
                            <i class="fas fa-external-link-alt"></i>
                            Ouvrir dans Google
                        </button> -->
                    </div>
                </header>

                <div class="google-calendar-container">
                    <iframe
                        src="https://calendar.google.com/calendar/embed?src=dylan.propre.eco%40gmail.com&ctz=Europe%2FParis"
                        style="border: 0; width: 100%; height: 600px;" frameborder="0" scrolling="no"></iframe>
                </div>
            </section>
        </div>
    </div>



    <!-- Scripts Firebase -->
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // =============================
        //  CONFIG / INIT FIREBASE (COMPAT)
        // =============================
        const firebaseConfig = {
            apiKey: "AIzaSyBzXEN0e-4dgh9NVVF7JGzpKtJrPnuzo0Y",
            authDomain: "copro-256d7.firebaseapp.com",
            projectId: "copro-256d7",
            storageBucket: "copro-256d7.firebasestorage.app",
            messagingSenderId: "665588381388",
            appId: "1:665588381388:web:a0567533ff1a62407db469",
            measurementId: "G-Y7YNZDDCTD"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Références d'éléments
        const status = document.getElementById('status');
        const notifBadge = document.getElementById('notifBadge');

        // Clé pour localStorage
        const DASHBOARD_AUTH_KEY = 'propre_eco_dashboard_auth_v1';

        // État d'authentification global
        window.isAuthenticated = false;

        // =============================
        //  NAVIGATION MOBILE
        // =============================
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButton = document.querySelector('.nav-toggle');
            const menu = document.querySelector('.nav-menu');

            if (toggleButton && menu) {
                toggleButton.addEventListener('click', () => {
                    menu.classList.toggle('open');
                });

                document.querySelectorAll('.nav-menu a').forEach(link => {
                    link.addEventListener('click', () => {
                        menu.classList.remove('open');
                    });
                });
            }
        });

        // =============================
        //  UTILITAIRES
        // =============================
        function addGoogleEvent() {
            const today = new Date();
            const dateStr = today.getFullYear() + String(today.getMonth() + 1).padStart(2, '0') + String(today.getDate()).padStart(2, '0');
            const url = `https://calendar.google.com/calendar/u/0/r/eventedit?dates=${dateStr}/${dateStr}&text=Travaux&location=&details=Description%20des%20travaux&ctz=Europe/Paris&src=dylan.propre.eco@gmail.com`;
            window.open(url, '_blank');
        }

        function showStatus(message, type) {
            status.className = `status ${type}`;
            status.style.display = 'block';

            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-times-circle'
            };

            status.innerHTML = `
                <i class="${icons[type]}"></i>
                ${message}
            `;

            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

        function openGoogleCalendar() {
            window.open('https://calendar.google.com/calendar/u/0?cid=ZHlsYW4ucHJvcHJlLmVjb0BnbWFpbC5jb20', '_blank');
        }

        // =============================
        //  AUTHENTIFICATION LOCALE
        // =============================
        document.getElementById('code-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const code = document.getElementById('code-input').value;
            const submitBtn = e.target.querySelector('button');

            if (code === "110389") {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authentification...';
                submitBtn.disabled = true;

                setTimeout(() => {
                    // Marquer comme authentifié
                    window.isAuthenticated = true;

                    // Sauvegarder dans localStorage
                    localStorage.setItem(DASHBOARD_AUTH_KEY, 'authenticated');

                    // Afficher l'élément de navigation des signalements
                    const navSignalements = document.querySelector('.nav-signalements');
                    if (navSignalements) {
                        navSignalements.classList.add('authenticated');
                    }

                    document.getElementById('gate').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'grid';
                    showStatus('Accès autorisé', 'success');
                    loadSignalements();
                    loadFeuilles();
                }, 700);
            } else {
                showStatus('Code de sécurité incorrect', 'error');
                document.getElementById('code-input').focus();

                // Animation d'erreur
                const form = document.getElementById('code-form');
                form.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    form.style.animation = '';
                }, 500);
            }
        });

        // =============================
        //  LECTURE DES DONNÉES (FIRESTORE - COMPAT)
        // =============================
        async function loadSignalements() {
            const tbody = document.getElementById('signalementsBody');

            try {
                const snapshot = await db.collection('signalements')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();

                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem; color: #6b7280;">
                                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                Aucun signalement trouvé
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = '';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    let imgHTML = '';

                    if (data.images && data.images.length > 0) {
                        imgHTML = data.images.map(img => `
                            <img src="${img.url}"
                                 class="thumb"
                                 alt="Image du signalement"
                                 onclick="window.open('${img.url}', '_blank')"
                                 loading="lazy">
                        `).join('');
                    } else {
                        imgHTML = '<span style="color: #6b7280; font-style: italic;">Aucune image</span>';
                    }

                    const date = data.createdAt && data.createdAt.toDate ?
                        data.createdAt.toDate().toLocaleString('fr-FR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 'Date inconnue';

                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${data.copro || 'Non spécifiée'}</strong></td>
                            <td>${data.description || 'Pas de description'}</td>
                            <td>${data.employee || 'Non spécifié'}</td>
                            <td>${imgHTML}</td>
                            <td>${date}</td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error('Erreur lors du chargement des signalements:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            Erreur de chargement des signalements
                        </td>
                    </tr>
                `;
            }
        }

        // Variables globales pour les filtres
        let allFeuilles = []; // Stocker toutes les feuilles

        async function loadFeuilles(nameFilter = '', dateFilter = '') {
            const tbody = document.getElementById("feuillesBody");

            try {
                // Si c'est le premier chargement, récupérer toutes les données
                if (allFeuilles.length === 0 || (!nameFilter && !dateFilter)) {
                    const snapshot = await db.collection("feuilles_passage")
                        .orderBy("createdAt", "desc")
                        .get();

                    if (snapshot.empty) {
                        tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 2rem; color: #6b7280;">
                            <i class="fas fa-file-alt" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            Aucune feuille de passage trouvée
                        </td>
                    </tr>
                `;
                        return;
                    }

                    allFeuilles = [];
                    snapshot.forEach(doc => {
                        allFeuilles.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                }

                // Filtrer les données
                let filteredFeuilles = allFeuilles;

                if (nameFilter) {
                    filteredFeuilles = filteredFeuilles.filter(feuille =>
                        (feuille.nom || '').toLowerCase().includes(nameFilter.toLowerCase())
                    );
                }

                if (dateFilter) {
                    filteredFeuilles = filteredFeuilles.filter(feuille => {
                        if (!feuille.createdAt) return false;
                        const feuilleDate = feuille.createdAt.toDate ?
                            feuille.createdAt.toDate() : new Date(feuille.createdAt);
                        const filterDate = new Date(dateFilter);
                        return feuilleDate.toDateString() === filterDate.toDateString();
                    });
                }

                // Afficher les résultats
                if (filteredFeuilles.length === 0) {
                    tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 2rem; color: #6b7280;">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        Aucune feuille trouvée avec ces critères
                    </td>
                </tr>
            `;
                    return;
                }

                tbody.innerHTML = "";

                // Limiter à 50 résultats pour les performances
                const displayFeuilles = filteredFeuilles.slice(0, 50);

                displayFeuilles.forEach(data => {
                    const tr = document.createElement("tr");

                    // Copropriété
                    const tdCopro = document.createElement("td");
                    tdCopro.innerHTML = `<strong>${data.copro || "Non spécifiée"}</strong>`;
                    tr.appendChild(tdCopro);

                    // Agent (nouvelle colonne)
                    const tdAgent = document.createElement("td");
                    tdAgent.innerHTML = `<strong>${data.nom || "Non spécifié"}</strong>`;
                    tr.appendChild(tdAgent);

                    // Photo
                    const tdPhoto = document.createElement("td");
                    if (data.url) {
                        const img = document.createElement("img");
                        img.src = data.url;
                        img.className = "thumb";
                        img.alt = "Feuille signée";
                        img.loading = "lazy";
                        img.onclick = () => window.open(data.url, "_blank");
                        tdPhoto.appendChild(img);
                    } else {
                        tdPhoto.innerHTML = '<span style="color: #6b7280; font-style: italic;">Pas de photo</span>';
                    }
                    tr.appendChild(tdPhoto);

                    // Date
                    const tdDate = document.createElement("td");
                    const date = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : new Date();
                    tdDate.textContent = date.toLocaleString("fr-FR", {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    tr.appendChild(tdDate);

                    tbody.appendChild(tr);
                });

                // Afficher un message si plus de 50 résultats
                if (filteredFeuilles.length > 50) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                <td colspan="4" style="text-align: center; padding: 1rem; background: #fef3c7; color: #92400e; font-style: italic;">
                    <i class="fas fa-info-circle"></i>
                    Affichage des 50 premiers résultats sur ${filteredFeuilles.length} trouvés
                </td>
            `;
                    tbody.appendChild(tr);
                }

            } catch (error) {
                console.error('Erreur lors du chargement des feuilles:', error);
                tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; padding: 2rem; color: #ef4444;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                    Erreur de chargement des feuilles
                </td>
            </tr>
        `;
            }
        }
        // Pagination globale
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredFeuilles = []; // Feuilles après filtrage

        async function loadFeuillesWithPagination(nameFilter = '', dateFilter = '') {
            const tbody = document.getElementById("feuillesBody");

            try {
                // Si c'est le premier chargement, récupérer toutes les données
                if (allFeuilles.length === 0 || (!nameFilter && !dateFilter)) {
                    const snapshot = await db.collection("feuilles_passage")
                        .orderBy("createdAt", "desc")
                        .get();

                    allFeuilles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                // Filtrer les données
                filteredFeuilles = allFeuilles;

                if (nameFilter) {
                    filteredFeuilles = filteredFeuilles.filter(f =>
                        (f.nom || '').toLowerCase().includes(nameFilter.toLowerCase())
                    );
                }
                if (dateFilter) {
                    filteredFeuilles = filteredFeuilles.filter(f => {
                        if (!f.createdAt) return false;
                        const fDate = f.createdAt.toDate ? f.createdAt.toDate() : new Date(f.createdAt);
                        const filterDate = new Date(dateFilter);
                        return fDate.toDateString() === filterDate.toDateString();
                    });
                }

                if (filteredFeuilles.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:2rem; color:#6b7280;">
                <i class="fas fa-search"></i> Aucune feuille trouvée</td></tr>`;
                    document.getElementById("paginationControls")?.remove();
                    return;
                }

                currentPage = 1; // Reset à la première page
                renderFeuillesPage();
                setupPaginationControls();
            } catch (error) {
                console.error(error);
            }
        }

        // Pagination pour les signalements
        let currentSignalementPage = 1;
        const signalementsPerPage = 10;
        let allSignalements = [];
        let filteredSignalements = [];

        async function loadSignalementsWithPagination() {
            const tbody = document.getElementById('signalementsBody');

            try {
                const snapshot = await db.collection('signalements')
                    .orderBy('createdAt', 'desc')
                    .get();

                allSignalements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filteredSignalements = [...allSignalements]; // initialise le tableau filtré


                if (allSignalements.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:2rem; color:#6b7280;">
                <i class="fas fa-inbox"></i> Aucun signalement trouvé</td></tr>`;
                    document.getElementById("signalementsPaginationControls").innerHTML = '';
                    return;
                }

                currentSignalementPage = 1;
                renderSignalementsPage();
                setupSignalementsPagination();
            } catch (error) {
                console.error(error);
            }
        }

        function renderSignalementsPage() {
            const tbody = document.getElementById('signalementsBody');
            tbody.innerHTML = '';

            const startIndex = (currentSignalementPage - 1) * signalementsPerPage;
            const pageItems = filteredSignalements.slice(startIndex, startIndex + signalementsPerPage);

            pageItems.forEach(data => {
                let imgHTML = '';
                if (data.images && data.images.length) {
                    imgHTML = data.images.map(img => `<img src="${img.url}" class="thumb" alt="Image" onclick="window.open('${img.url}','_blank')" loading="lazy">`).join('');
                } else {
                    imgHTML = '<span style="color: #6b7280; font-style: italic;">Aucune image</span>';
                }

                const date = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Date inconnue';

                tbody.innerHTML += `
            <tr>
                <td><strong>${data.copro || 'Non spécifiée'}</strong></td>
                <td>${data.description || 'Pas de description'}</td>
                <td>${data.employee || 'Non spécifié'}</td>
                <td>${imgHTML}</td>
                <td>${date}</td>
            </tr>
        `;
            });
        }

        function setupSignalementsPagination() {
            const container = document.getElementById('signalementsPaginationControls');
            container.innerHTML = '';

            const totalPages = Math.ceil(allSignalements.length / signalementsPerPage);
            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = "btn btn-small";
                btn.style.margin = "0 0.25rem";
                if (i === currentSignalementPage) btn.style.fontWeight = "bold";

                btn.addEventListener('click', () => {
                    currentSignalementPage = i;
                    renderSignalementsPage();
                    setupSignalementsPagination();
                });

                container.appendChild(btn);
            }
        }


        function renderFeuillesPage() {
            const tbody = document.getElementById("feuillesBody");
            tbody.innerHTML = "";

            const startIndex = (currentPage - 1) * itemsPerPage;
            const pageItems = filteredFeuilles.slice(startIndex, startIndex + itemsPerPage);

            pageItems.forEach(data => {
                const tr = document.createElement("tr");

                const tdCopro = document.createElement("td");
                tdCopro.innerHTML = `<strong>${data.copro || "Non spécifiée"}</strong>`;
                tr.appendChild(tdCopro);

                const tdAgent = document.createElement("td");
                tdAgent.innerHTML = `<strong>${data.nom || "Non spécifié"}</strong>`;
                tr.appendChild(tdAgent);

                const tdPhoto = document.createElement("td");
                if (data.url) {
                    const img = document.createElement("img");
                    img.src = data.url;
                    img.className = "thumb";
                    img.alt = "Feuille signée";
                    img.loading = "lazy";
                    img.onclick = () => window.open(data.url, "_blank");
                    tdPhoto.appendChild(img);
                } else {
                    tdPhoto.innerHTML = '<span style="color: #6b7280; font-style: italic;">Pas de photo</span>';
                }
                tr.appendChild(tdPhoto);

                const tdDate = document.createElement("td");
                const date = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : new Date();
                tdDate.textContent = date.toLocaleString("fr-FR", {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                tr.appendChild(tdDate);

                tbody.appendChild(tr);
            });
        }

        function setupPaginationControls() {
            const existing = document.getElementById("paginationControls");
            if (existing) existing.remove();

            const totalPages = Math.ceil(filteredFeuilles.length / itemsPerPage);
            if (totalPages <= 1) return; // Pas besoin de pagination

            const container = document.createElement("div");
            container.id = "paginationControls";
            container.style.textAlign = "center";
            container.style.marginTop = "1rem";

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement("button");
                btn.textContent = i;
                btn.className = "btn btn-small";
                btn.style.margin = "0 0.25rem";
                if (i === currentPage) btn.style.fontWeight = "bold";

                btn.addEventListener("click", () => {
                    currentPage = i;
                    renderFeuillesPage();
                    setupPaginationControls(); // mettre à jour le style du bouton actif
                });

                container.appendChild(btn);
            }

            const tableContainer = document.querySelector("#feuillesBody").closest(".table-container");
            tableContainer.after(container);
        }

        // Fonction pour appliquer les filtres
        function applyFeuillesFilters() {
            const nameFilter = document.getElementById('filterName').value.trim();
            const dateFilter = document.getElementById('filterDate').value;

            loadFeuillesWithPagination(nameFilter, dateFilter);

            if (nameFilter || dateFilter) {
                showFastNotification(`Filtre appliqué : ${nameFilter ? 'Agent: ' + nameFilter : ''} ${dateFilter ? 'Date: ' + dateFilter : ''}`, 'info', 3000);
            }
        }

        // Fonction pour effacer les filtres
        function clearFeuillesFilters() {
            document.getElementById('filterName').value = '';
            document.getElementById('filterDate').value = '';
            loadFeuillesWithPagination(); // Recharger sans filtres
            showFastNotification('Filtres effacés', 'info', 2000);
        }
        // =============================
        //  NOTIFICATION BADGE (TEMPS RÉEL) - COMPAT
        // =============================
        class NotificationService {
            constructor() {
                this.init();
            }

            async updateNotificationBadge() {
                try {
                    const querySnapshot = await db.collection('signalements').orderBy('createdAt', 'desc').get();
                    const count = querySnapshot.size;

                    if (notifBadge) {
                        notifBadge.textContent = count;
                        notifBadge.classList.remove('loading');

                        if (count > 0) {
                            notifBadge.classList.add('updated');
                            setTimeout(() => {
                                notifBadge.classList.remove('updated');
                            }, 600);
                        }
                    }
                } catch (error) {
                    console.error("Erreur lors de la récupération du nombre de signalements:", error);
                    if (notifBadge) {
                        notifBadge.textContent = "!";
                        notifBadge.classList.remove('loading');
                    }
                }
            }

            setupRealTimeListener() {
                db.collection('signalements').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
                    const count = snapshot.size;
                    if (notifBadge) {
                        notifBadge.textContent = count;
                        notifBadge.classList.remove('loading');

                        if (count > 0 && window.isAuthenticated) {
                            notifBadge.classList.add('updated');
                            setTimeout(() => {
                                notifBadge.classList.remove('updated');
                            }, 600);
                        }
                    }
                }, (error) => {
                    console.error("Erreur lors de l'écoute des signalements:", error);
                    if (notifBadge) {
                        notifBadge.textContent = "!";
                        notifBadge.classList.remove('loading');
                    }
                });
            }

            init() {
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(() => {
                        this.updateNotificationBadge();
                        this.setupRealTimeListener();
                    }, 500);
                });
            }
        }

        new NotificationService();

        // =============================
        //  NOTIFICATIONS VISUELLES
        // =============================
        function showFastNotification(message, type = 'info', duration = 4000) {
            const notification = document.createElement('div');
            notification.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' :
                    type === 'warning' ? 'linear-gradient(135deg, #f59e0b, #d97706)' :
                        type === 'error' ? 'linear-gradient(135deg, #ef4444, #dc2626)' :
                            'linear-gradient(135deg, #3b82f6, #2563eb)'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        z-index: 1000;
        font-weight: 600;
        animation: slideInRight 0.3s ease-out;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        max-width: 400px;
        font-size: 0.9rem;
    `;

            const icons = {
                success: 'fas fa-check-circle',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            notification.innerHTML = `<i class="${icons[type]}"></i> ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        // =============================
        //  ZIP TÉLÉCHARGEMENT & SUPPRESSION (FEUILLES)
        // =============================
        async function downloadAllFeuilles() {
            const downloadBtn = document.getElementById('downloadAllFeuilles');
            const originalContent = downloadBtn.innerHTML;

            try {
                downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Téléchargement...';
                downloadBtn.disabled = true;

                showFastNotification('Récupération des feuilles...', 'info', 2000);

                const snapshot = await firebase.firestore().collection('feuilles_passage').orderBy('createdAt', 'desc').get();
                const feuilles = [];

                snapshot.forEach(doc => {
                    feuilles.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                if (feuilles.length === 0) {
                    showFastNotification('Aucune feuille à télécharger', 'warning');
                    return;
                }

                showFastNotification(`Création de l'archive de ${feuilles.length} feuilles...`, 'info', 3000);

                const zip = new JSZip();
                let processed = 0;
                let successful = 0;

                for (const feuille of feuilles) {
                    try {
                        if (feuille.url) {
                            const response = await fetch(feuille.url);
                            if (!response.ok) throw new Error(`HTTP ${response.status}`);

                            const blob = await response.blob();

                            const date = feuille.createdAt && feuille.createdAt.toDate ?
                                feuille.createdAt.toDate().toISOString().slice(0, 19).replace(/:/g, '-') :
                                'date_inconnue';
                            const copro = (feuille.copro || 'copro_inconnue').replace(/[^a-zA-Z0-9]/g, '_');
                            const extension = feuille.url.split('.').pop().split('?')[0] || 'jpg';
                            const filename = `${date}_${copro}_${feuille.id}.${extension}`;

                            zip.file(filename, blob);
                            successful++;
                        }
                        processed++;
                        downloadBtn.innerHTML = `<i class=\"fas fa-spinner fa-spin\"></i> ${processed}/${feuilles.length}`;
                    } catch (imageError) {
                        console.error(`Erreur téléchargement image ${feuille.id}:`, imageError);
                        processed++;
                    }
                }

                downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération ZIP...';

                const zipBlob = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: { level: 6 }
                });

                const url = window.URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `feuilles_passage_${new Date().toISOString().slice(0, 10)}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showFastNotification(`Archive téléchargée : ${successful}/${feuilles.length} feuilles`, 'success', 5000);

            } catch (error) {
                console.error('Erreur téléchargement:', error);
                showFastNotification('Erreur lors du téléchargement', 'error');
            } finally {
                downloadBtn.innerHTML = originalContent;
                downloadBtn.disabled = false;
            }
        }

        async function deleteAllFeuilles() {
            try {
                const countSnapshot = await firebase.firestore().collection('feuilles_passage').get();
                const count = countSnapshot.size;

                if (count === 0) {
                    showFastNotification('Aucune feuille à supprimer', 'warning');
                    return;
                }

                if (!confirm(`⚠️ ATTENTION ⚠️\n\nVous allez supprimer définitivement ${count} feuilles de passage.\n\nCette action supprimera :\n• Toutes les images sur ImgBB\n• Toutes les données sur Firebase\n\nCette action est IRRÉVERSIBLE !\n\nContinuer ?`)) {
                    return;
                }

                if (!confirm(`Dernière confirmation !\n\nÊtes-vous absolument certain de vouloir supprimer ${count} feuilles définitivement ?`)) {
                    return;
                }

                const confirmation = prompt('Tapez "SUPPRIMER" pour confirmer la suppression définitive :');
                if (confirmation !== 'SUPPRIMER') {
                    showFastNotification('Suppression annulée', 'warning');
                    return;
                }

                const deleteBtn = document.getElementById('deleteAllFeuilles');
                const originalContent = deleteBtn.innerHTML;

                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Suppression...';
                deleteBtn.disabled = true;

                showFastNotification('Suppression en cours...', 'info', 3000);

                const snapshot = await firebase.firestore().collection('feuilles_passage').get();

                let processed = 0;
                let deletedImages = 0;
                let deletedDocs = 0;

                for (const doc of snapshot.docs) {
                    const data = doc.data();

                    try {
                        if (data.deleteUrl) {
                            try {
                                const response = await fetch(data.deleteUrl);
                                if (response.ok) {
                                    deletedImages++;
                                }
                            } catch (imgError) {
                                console.error(`Erreur suppression ImgBB ${doc.id}:`, imgError);
                            }
                        }

                        await doc.ref.delete();
                        deletedDocs++;

                    } catch (docError) {
                        console.error(`Erreur suppression document ${doc.id}:`, docError);
                    }

                    processed++;
                    deleteBtn.innerHTML = `<i class=\"fas fa-spinner fa-spin\"></i> ${processed}/${snapshot.docs.length}`;
                }

                await loadFeuilles();

                showFastNotification(`Suppression terminée : ${deletedDocs} documents et ${deletedImages} images supprimés`, 'success', 6000);

            } catch (error) {
                console.error('Erreur suppression:', error);
                showFastNotification('Erreur lors de la suppression', 'error');
            } finally {
                const deleteBtn = document.getElementById('deleteAllFeuilles');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Tout supprimer';
                deleteBtn.disabled = false;
            }
        }

        // =============================
        //  INIT & LISTENERS
        // =============================
        document.addEventListener('DOMContentLoaded', function () {
            // Vérifier l'authentification sauvegardée
            checkSavedAuth();

            setTimeout(() => {
                const applyFiltersBtn = document.getElementById('applyFilters');
                const clearFiltersBtn = document.getElementById('clearFilters');
                const filterNameInput = document.getElementById('filterName');
                const filterDateInput = document.getElementById('filterDate');

                if (applyFiltersBtn) {
                    applyFiltersBtn.addEventListener('click', applyFeuillesFilters);
                }

                if (clearFiltersBtn) {
                    clearFiltersBtn.addEventListener('click', clearFeuillesFilters);
                }

                // Appliquer les filtres en temps réel lors de la saisie
                if (filterNameInput) {
                    filterNameInput.addEventListener('input', () => {
                        // Délai pour éviter trop d'appels
                        clearTimeout(window.filterTimeout);
                        window.filterTimeout = setTimeout(applyFeuillesFilters, 500);
                    });
                }

                if (filterDateInput) {
                    filterDateInput.addEventListener('change', applyFeuillesFilters);
                }
            }, 500);
            // Boutons feuilles (après rendu DOM)
            setTimeout(() => {
                const downloadBtn = document.getElementById('downloadAllFeuilles');
                const deleteBtn = document.getElementById('deleteAllFeuilles');

                if (downloadBtn) {
                    downloadBtn.addEventListener('click', downloadAllFeuilles);
                }

                if (deleteBtn) {
                    deleteBtn.addEventListener('click', deleteAllFeuilles);
                }
            }, 400);
        });

        // Déplacement de checkSavedAuth pour être visible
        function checkSavedAuth() {
            const savedAuth = localStorage.getItem(DASHBOARD_AUTH_KEY);
            if (savedAuth === 'authenticated') {
                window.isAuthenticated = true;

                const navSignalements = document.querySelector('.nav-signalements');
                if (navSignalements) {
                    navSignalements.classList.add('authenticated');
                }

                document.getElementById('gate').style.display = 'none';
                document.getElementById('dashboard').style.display = 'grid';

                // ← versions avec pagination
                loadSignalementsWithPagination();
                loadFeuillesWithPagination();
            }
        }

        // Fermer le modal avec Escape (si tu en ajoutes plus tard)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('noteModal');
                if (modal && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                }
            }
        });
        // Filtrage en temps réel pour les signalements
        const filterCoproInput = document.getElementById('filterCopro');
        const filterDateInput = document.getElementById('filterSignalDate');

        if (filterCoproInput) {
            filterCoproInput.addEventListener('input', () => {
                clearTimeout(window.signalementFilterTimeout);
                window.signalementFilterTimeout = setTimeout(applySignalementsFilters, 500);
            });
        }

        if (filterDateInput) {
            filterDateInput.addEventListener('change', () => {
                clearTimeout(window.signalementFilterTimeout);
                window.signalementFilterTimeout = setTimeout(applySignalementsFilters, 500);
            });
        }

        // Filtrer les signalements
        function applySignalementsFilters() {
            const coproFilter = document.getElementById('filterCopro').value.trim().toLowerCase();
            const dateFilter = document.getElementById('filterSignalDate').value;

            filteredSignalements = allSignalements.filter(item => {
                let match = true;
                if (coproFilter) {
                    match = match && (item.copro || '').toLowerCase().includes(coproFilter);
                }
                if (dateFilter) {
                    if (!item.createdAt) return false;
                    const itemDate = item.createdAt.toDate ? item.createdAt.toDate() : new Date(item.createdAt);
                    const filterDate = new Date(dateFilter);
                    match = match && (itemDate.toDateString() === filterDate.toDateString());
                }
                return match;
            });

            currentSignalementPage = 1;
            renderSignalementsPage();
            setupSignalementsPagination();

            if (coproFilter || dateFilter) {
                showFastNotification(`Filtre appliqué : ${coproFilter ? 'Copro: ' + coproFilter : ''} ${dateFilter ? 'Date: ' + dateFilter : ''}`, 'info', 3000);
            }
        }

        // Effacer les filtres
        function clearSignalementsFilters() {
            document.getElementById('filterCopro').value = '';
            document.getElementById('filterSignalDate').value = '';
            filteredSignalements = [...allSignalements];
            currentSignalementPage = 1;
            renderSignalementsPage();
            setupSignalementsPagination();
            showFastNotification('Filtres effacés', 'info', 2000);

        }

        // Event listeners
        document.getElementById('applySignalFilters')?.addEventListener('click', applySignalementsFilters);
        document.getElementById('clearSignalFilters')?.addEventListener('click', clearSignalementsFilters);

    </script>
</body>

</html>