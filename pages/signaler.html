<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />    <title>Signaler un probl√®me - Propre Eco</title>

    <!-- PWA Configuration -->
    <link rel="icon" type="image/png" href="../img/logo.png" />
    <link rel="apple-touch-icon" href="../img/logo.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="../img/logo.png" />
    <link rel="manifest" href="../manifest.json">

    <!-- PWA M√©tadonn√©es -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Propre Eco">
    <meta name="theme-color" content="#10B981">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <!-- Scripts et styles -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/signaler.css">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/index-specific.css">
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" href="../css/modals.css">
    <link rel="stylesheet" href="../css/navbar.css">

</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <button class="hamburger-btn" aria-label="Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>

            <a href="../index.html" class="logo">
                <img src="../img/logo.png" width="60px" alt="Logo Propre Eco">
                Propre Eco Assistant
            </a>

            <div class="header-spacer"></div>
        </div>
    </header>

    <div class="sidebar-overlay"></div>
    <nav class="sidebar-menu">
        <div class="sidebar-header">
            <img src="../img/logo.png" width="50px" alt="Logo">
            <h3>Propre Eco</h3>
            <button class="sidebar-close" aria-label="Fermer">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="sidebar-content">
            <div class="menu-section">
                <span class="menu-section-title">Navigation</span>
                <ul class="sidebar-nav">
                    <li>
                        <a href="../index.html">
                            <i class="fas fa-home"></i>
                            <span>Accueil</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="signaler.html">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Signaler</span>
                        </a>
                    </li>
                    <li>
                        <a href="Feuilles.html">
                            <i class="fas fa-file-alt"></i>
                            <span>Feuilles</span>
                        </a>
                    </li>
                    <li>
                        <a href="Specifique.html">
                            <i class="fas fa-hard-hat"></i>
                            <span>Specifique</span>
                        </a>
                    </li>
                    <li>
                        <a href="pointeuse.html">
                            <i class="fas fa-clock"></i>
                            <span>Pointeuse</span>
                        </a>
                    </li>
                    <li>
                        <a href="devis.html">
                            <i class="fas fa-file-invoice"></i>
                            <span>Devis</span>
                        </a>
                    </li>
                    <li>
                        <a href="dashbord.html">
                            <i class="fas fa-columns"></i>
                            <span>Tableau de bord</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="main-card">
            <div class="card-header">
                <h1>
                    <i class="fas fa-exclamation-triangle"></i>
                    Signaler un probl√®me
                </h1>
                <p>Soumettez un probl√®me rencontr√© dans vos copropri√©t√©s</p>
            </div>

            <div class="card-content">
                <form id="report-form" class="form">
                    <!-- Type de signalement -->
                    <div class="form-group">
                        <label for="type-signalement" class="form-label">
                            <i class="fas fa-clipboard-list"></i>
                            Type de signalement
                        </label>
                        <select id="type-signalement" class="form-input" required>
                            <option value="probleme">Probl√®me</option>
                            <option value="consommable">Consommable</option>
                        </select>
                    </div>

                    <!-- Copropri√©t√© -->
                    <div class="form-group">
                        <label for="copro-input" class="form-label">
                            <i class="fas fa-building"></i>
                            Copropri√©t√©
                        </label>
                        <input type="text" id="copro-input" class="form-input" placeholder="Nom de la copropri√©t√©..."
                            required />
                    </div>

                    <!-- Champs PROBLEME (visibles par d√©faut) -->
                    <div id="probleme-fields">
                        <!-- Description -->
                        <div class="form-group">
                            <label for="desc-input" class="form-label">
                                <i class="fas fa-comment-alt"></i>
                                Description du probl√®me
                            </label>

                            <div class="alert">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Merci de renseigner le num√©ro de batiment si la copropri√©t√© en comporte
                                    plusieurs.</span>
                            </div>
                            <textarea id="desc-input" class="form-input form-textarea"
                                placeholder="D√©crivez le probl√®me rencontr√© en d√©tail..." required></textarea>
                        </div>
                    </div>

                    <!-- Champs CONSOMMABLE (cach√©s par d√©faut) -->
                    <div id="consommable-fields" style="display: none;">
                        <div class="form-group">
                            <label for="consommable-type" class="form-label">
                                <i class="fas fa-lightbulb"></i>
                                Type de consommable
                            </label>
                            <input type="text" id="consommable-type" class="form-input"
                                placeholder="Ex: Ampoule LED, Pile AAA, Produit d'entretien..." />
                        </div>

                        <div class="form-group">
                            <label for="consommable-quantite" class="form-label">
                                <i class="fas fa-hashtag"></i>
                                Quantit√©
                            </label>
                            <input type="number" id="consommable-quantite" class="form-input" placeholder="Nombre"
                                min="1" value="1" />
                        </div>
                    </div>

                    <!-- Employ√© -->
                    <div class="form-group">
                        <label for="signature-input" class="form-label">
                            <i class="fas fa-user"></i>
                            Signature de l'agent
                        </label>
                        <input type="text" id="signature-input" class="form-input" placeholder="Votre pr√©nom"
                            required />
                    </div>

                    <!-- Images -->
                    <div class="form-group">
                        <label for="images-input" class="form-label">
                            <i class="fas fa-images"></i>
                            Ajouter des images
                        </label>

                        <div class="upload-info">
                            <i class="fas fa-info-circle"></i>
                            <span>Maximum 3 images ‚Ä¢ Format JPEG/PNG ‚Ä¢ Compression automatique</span>
                        </div>

                        <div class="upload-section">
                            <div class="upload-area" id="upload-area-signaler">
                                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                <div class="upload-text">Touchez pour s√©lectionner</div>
                                <div class="upload-hint">ou glissez-d√©posez vos images ici</div>
                                <input type="file" id="images-input" class="file-input-hidden" multiple
                                    accept="image/*" />
                            </div>

                            <div id="image-preview" class="image-preview-list"></div>
                        </div>
                    </div>
                    <!-- Bouton d'envoi -->
                    <button class="btn btn-warning" type="submit">
                        <i class="fas fa-paper-plane"></i>
                        Envoyer le signalement
                    </button>

                    <div id="status" class="status"></div>
                </form>
            </div>
        </div>
    </div>

    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="loading-container">
            <div class="loading-spinner">
                <div class="spinner-circle"></div>
                <div class="spinner-circle"></div>
                <div class="spinner-circle"></div>
                <div class="loading-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
            <h3 class="loading-title">Envoi en cours...</h3>
            <p class="loading-message">Nous envoyons votre signalement et les images associ√©es</p>
            <div class="loading-progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>

    <div id="successOverlay" class="success-overlay" style="display: none;">
        <div class="success-container">
            <div class="success-checkmark">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="success-title">Signalement envoy√© !</h3>
            <p class="success-message">Votre signalement a √©t√© transmis avec succ√®s</p>
            <div class="success-bar">
                <div class="success-bar-fill"></div>
            </div>
        </div>
    </div>

    <footer class="app-footer">
        Developed with <span style="color: #ff6b6b;">‚ù§Ô∏è</span> by Ashborn
    </footer>

    <script type="module">

        let notif = false;//(invers√©)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBzXEN0e-4dgh9NVVF7JGzpKtJrPnuzo0Y",
            authDomain: "copro-256d7.firebaseapp.com",
            projectId: "copro-256d7",
            storageBucket: "copro-256d7.firebasestorage.app",
            messagingSenderId: "665588381388",
            appId: "1:665588381388:web:a0567533ff1a62407db469",
            measurementId: "G-Y7YNZDDCTD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Elements DOM
        const form = document.getElementById('report-form');
        const status = document.getElementById('status');
        const imagesInput = document.getElementById('images-input');
        const imagePreview = document.getElementById('image-preview');
        const API_KEY = "7f0e4433bcc19c0f1408f57919fbcf14";

        // Gestion de la signature sauvegard√©e
        const signatureInput = document.getElementById('signature-input');
        const savedSignature = localStorage.getItem('agent-signature');

        // Charger la signature sauvegard√©e au chargement de la page
        if (savedSignature) {
            signatureInput.value = savedSignature;
            signatureInput.readOnly = true;
            signatureInput.style.backgroundColor = '#f0f8ff';

            // Ajouter un bouton pour changer la signature
            const signatureGroup = signatureInput.parentElement;
            const changeButton = document.createElement('div');
            changeButton.className = 'signature-controls';
            changeButton.innerHTML = `
        <div class="signature-saved">
            <i class="fas fa-check-circle"></i>
            Signature sauvegard√©e
        </div>
        <button type="button" class="change-signature" onclick="changeSignature()">
            <i class="fas fa-edit"></i> Modifier
        </button>
    `;
            signatureGroup.appendChild(changeButton);
        }

        // Fonction pour permettre de changer la signature
        window.changeSignature = function () {
            signatureInput.readOnly = false;
            signatureInput.style.backgroundColor = '';
            signatureInput.focus();
            signatureInput.select();

            // Supprimer les contr√¥les
            const controls = document.querySelector('.signature-controls');
            if (controls) {
                controls.remove();
            }
        };

        // Sauvegarder la signature quand l'utilisateur tape
        signatureInput.addEventListener('blur', function () {
            if (this.value.trim()) {
                localStorage.setItem('agent-signature', this.value.trim());
            }
        });

        // Variables globales pour les images
        let selectedFiles = [];
        let compressedFiles = [];

        // Fonction de compression intelligente d'image
        // Fonction de compression intelligente d'image AM√âLIOR√âE
        async function compressImageSmart(file, maxW = 1200, maxH = 900, quality = 0.8) {
            // Augmenter la taille max et la qualit√© de base

            if ('createImageBitmap' in window) {
                try {
                    const bitmap = await createImageBitmap(file, { imageOrientation: 'from-image' });
                    const { blob } = await drawToCanvas(bitmap.width, bitmap.height, (canvas, ctx) => {
                        const { w, h } = fit(bitmap.width, bitmap.height, maxW, maxH);
                        canvas.width = w;
                        canvas.height = h;
                        ctx.drawImage(bitmap, 0, 0, w, h);
                    }, quality);

                    // Seulement si l'image est VRAIMENT trop lourde (+ de 500KB), r√©duire la qualit√©
                    if (blob.size > 500 * 1024) {
                        const { blob: blob2 } = await drawToCanvas(bitmap.width, bitmap.height, (canvas, ctx) => {
                            const { w, h } = fit(bitmap.width, bitmap.height, maxW, maxH);
                            canvas.width = w;
                            canvas.height = h;
                            ctx.drawImage(bitmap, 0, 0, w, h);
                        }, 0.65); // Qualit√© moins agressive
                        return { blob: blob2 };
                    }
                    return { blob };
                } catch (error) {
                    console.error('Erreur createImageBitmap:', error);
                }
            }

            // Fallback avec Image classique
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = async () => {
                    try {
                        const { blob } = await drawToCanvas(img.width, img.height, (canvas, ctx) => {
                            const { w, h } = fit(img.width, img.height, maxW, maxH);
                            canvas.width = w;
                            canvas.height = h;

                            // Am√©liorer la qualit√© de rendu
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';

                            ctx.drawImage(img, 0, 0, w, h);
                        }, quality);

                        // Seulement si l'image est VRAIMENT trop lourde
                        if (blob.size > 500 * 1024) {
                            const { blob: blob2 } = await drawToCanvas(img.width, img.height, (canvas, ctx) => {
                                const { w, h } = fit(img.width, img.height, maxW, maxH);
                                canvas.width = w;
                                canvas.height = h;

                                ctx.imageSmoothingEnabled = true;
                                ctx.imageSmoothingQuality = 'high';

                                ctx.drawImage(img, 0, 0, w, h);
                            }, 0.65);
                            resolve({ blob: blob2 });
                        } else {
                            resolve({ blob });
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                img.onerror = () => reject(new Error('Impossible de charger l\'image'));
                img.src = URL.createObjectURL(file);
            });
        }
        function fit(w, h, maxW, maxH) {
            let rw = w, rh = h;
            if (rw > rh && rw > maxW) {
                rh = Math.round(rh * (maxW / rw));
                rw = maxW;
            } else if (rh >= rw && rh > maxH) {
                rw = Math.round(rw * (maxH / rh));
                rh = maxH;
            }
            return { w: rw, h: rh };
        }

        function drawToCanvas(srcW, srcH, drawCallback, quality = 0.6) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                try {
                    drawCallback(canvas, ctx);
                    canvas.toBlob(blob => {
                        if (!blob) return reject(new Error('√âchec de la conversion en blob'));
                        resolve({ blob });
                    }, 'image/jpeg', quality);
                } catch (e) {
                    reject(e);
                }
            });
        }

        // Upload vers ImgBB
        async function uploadToImgBB(blob) {
            const formData = new FormData();
            formData.append("image", blob);

            const res = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, {
                method: "POST",
                body: formData
            });

            if (!res.ok) throw new Error("Upload ImgBB √©chou√©");

            const data = await res.json();
            return {
                url: data.data.display_url,
                deleteUrl: data.data.delete_url
            };
        }

        // Gestion des images
        // Click sur zone d'upload
        const uploadArea = document.getElementById('upload-area-signaler');
        if (uploadArea) {
            uploadArea.addEventListener('click', () => {
                imagesInput.click();
            });

            // Drag & drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                if (files.length > 0) {
                    handleImageSelection(files);
                }
            });
        }

        // Gestion des images
        imagesInput.addEventListener('change', async function (e) {
            const files = Array.from(e.target.files);
            handleImageSelection(files);
        });

        async function handleImageSelection(files) {
            // Limiter √† 3 images
            if (files.length > 3) {
                showStatus('Maximum 3 images autoris√©es', 'error');
                return;
            }

            selectedFiles = files;
            compressedFiles = [];

            // Afficher loading
            if (uploadArea) {
                uploadArea.innerHTML = `
            <div class="upload-loading">
                <div class="upload-spinner"></div>
                <div class="upload-progress">Compression...</div>
            </div>
        `;
            }

            try {
                // Compresser chaque image
                for (let i = 0; i < files.length; i++) {
                    const loadingDiv = uploadArea?.querySelector('.upload-progress');
                    if (loadingDiv) {
                        loadingDiv.textContent = `Compression ${i + 1}/${files.length}...`;
                    }

                    const compressed = await compressImageSmart(files[i]);
                    compressedFiles.push(compressed.blob);
                }

                // Restaurer zone upload
                if (uploadArea) {
                    uploadArea.innerHTML = `
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <div class="upload-text">Touchez pour s√©lectionner</div>
                <div class="upload-hint">ou glissez-d√©posez vos images ici</div>
            `;
                }

                await displayImagePreview(files, compressedFiles);
                // showStatus('Images pr√™tes √† envoyer !', 'success');

            } catch (error) {
                console.error('Erreur compression:', error);

                if (uploadArea) {
                    uploadArea.innerHTML = `
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <div class="upload-text">Touchez pour s√©lectionner</div>
                <div class="upload-hint">ou glissez-d√©posez vos images ici</div>
            `;
                }

                showStatus('Erreur lors de la compression', 'error');
            }
        }

        // Affichage des previews - VERSION LISTE COMPACTE
        async function displayImagePreview(originalFiles, compressedBlobs) {
            imagePreview.innerHTML = '';

            for (let i = 0; i < originalFiles.length; i++) {
                const originalFile = originalFiles[i];
                const compressedBlob = compressedBlobs[i];

                const reader = new FileReader();
                reader.onload = function (e) {
                    const compressedKB = (compressedBlob.size / 1024).toFixed(0);
                    const fileName = originalFile.name.length > 25
                        ? originalFile.name.substring(0, 22) + '...'
                        : originalFile.name;

                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-list-item';
                    previewItem.innerHTML = `
                <img src="${e.target.result}" alt="Image ${i + 1}" class="preview-list-image">
                <div class="preview-list-info">
                    <div class="preview-list-name">${fileName}</div>
                    <div class="preview-list-size">${compressedKB} KB</div>
                </div>
                <button type="button" class="preview-list-remove" data-index="${i}">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;

                    // Event listener sur le bouton
                    previewItem.querySelector('.preview-list-remove').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeImage(parseInt(e.currentTarget.dataset.index));
                    });

                    imagePreview.appendChild(previewItem);

                    // Info compression apr√®s derni√®re image
                    if (i === originalFiles.length - 1) {
                        const totalOriginal = originalFiles.reduce((sum, file) => sum + file.size, 0);
                        const totalCompressed = compressedBlobs.reduce((sum, blob) => sum + blob.size, 0);
                        const reduction = ((1 - totalCompressed / totalOriginal) * 100).toFixed(0);

                        ;
                        imagePreview.appendChild(compressionInfo);
                    }
                };
                reader.readAsDataURL(compressedBlob);
            }
        }

        // Supprimer une image
        function removeImage(index) {
            selectedFiles.splice(index, 1);
            compressedFiles.splice(index, 1);

            if (selectedFiles.length > 0) {
                displayImagePreview(selectedFiles, compressedFiles);
            } else {
                imagePreview.innerHTML = '';
                imagesInput.value = '';
            }
        }
        // Helper pour cr√©er FileList
        function createFileList(files) {
            const dt = new DataTransfer();
            files.forEach(file => dt.items.add(file));
            return dt.files;
        }


        // Fonction globale pour supprimer une image
        window.removeImage = function (index) {
            selectedFiles.splice(index, 1);
            compressedFiles.splice(index, 1);

            if (selectedFiles.length > 0) {
                displayImagePreview(selectedFiles, compressedFiles);
            } else {
                imagePreview.innerHTML = '';
            }

            // Mettre √É¬† jour l'input file
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            imagesInput.files = dt.files;
        };

        // Affichage des messages de statut
        function showStatus(message, type) {
            status.className = `status ${type}`;
            status.style.display = 'block';

            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-times-circle',
                loading: 'fas fa-spinner fa-spin'
            };

            status.innerHTML = `
                <i class="${icons[type]}"></i>
                ${message}
            `;

            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        // Gestion du changement de type de signalement
        const typeSignalement = document.getElementById('type-signalement');
        const problemeFields = document.getElementById('probleme-fields');
        const consommableFields = document.getElementById('consommable-fields');
        const descInput = document.getElementById('desc-input');
        const consommableType = document.getElementById('consommable-type');
        const consommableQuantite = document.getElementById('consommable-quantite');

        typeSignalement.addEventListener('change', function () {
            if (this.value === 'consommable') {
                // Afficher champs consommables
                problemeFields.style.display = 'none';
                consommableFields.style.display = 'block';

                // Rendre les champs requis/non-requis
                descInput.removeAttribute('required');
                consommableType.setAttribute('required', 'required');
                consommableQuantite.setAttribute('required', 'required');
            } else {
                // Afficher champs probl√®me
                problemeFields.style.display = 'block';
                consommableFields.style.display = 'none';

                // Rendre les champs requis/non-requis
                descInput.setAttribute('required', 'required');
                consommableType.removeAttribute('required');
                consommableQuantite.removeAttribute('required');
            }
        });

        // Soumission du formulaire
        // Soumission du formulaire
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const copro = document.getElementById('copro-input').value.trim();
            const employee = document.getElementById('signature-input').value.trim();
            const typeSignal = document.getElementById('type-signalement').value;

            // Sauvegarder la signature si ce n'est pas d√©j√† fait
            if (employee) {
                localStorage.setItem('agent-signature', employee);
            }

            // Validation selon le type
            if (typeSignal === 'probleme') {
                const description = document.getElementById('desc-input').value.trim();
                if (!copro || !description || !employee) {
                    showStatus('Veuillez remplir tous les champs obligatoires', 'error');
                    return;
                }
            } else if (typeSignal === 'consommable') {
                const consomType = document.getElementById('consommable-type').value.trim();
                const consomQuantite = document.getElementById('consommable-quantite').value.trim();
                if (!copro || !consomType || !consomQuantite || !employee) {
                    showStatus('Veuillez remplir tous les champs obligatoires', 'error');
                    return;
                }
            }

            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            setTimeout(() => loading.classList.add('active'), 100);

            try {
                let images = [];

                // Upload des images compress√©es si pr√©sentes
                if (compressedFiles.length > 0) {
                    showStatus(`Envoi des images en cours... (0/${compressedFiles.length})`, "loading");

                    for (let i = 0; i < compressedFiles.length; i++) {
                        try {
                            showStatus(`Upload des images... (${i + 1}/${compressedFiles.length})`, "loading");
                            const uploaded = await uploadToImgBB(compressedFiles[i]);
                            images.push(uploaded);
                        } catch (err) {
                            console.error("Erreur upload image :", err);
                            showStatus(`Erreur lors de l'envois de l'image ${i + 1}`, "error");
                        }
                    }
                }


                // Enregistrer selon le type
                if (typeSignal === 'probleme') {
                    const description = document.getElementById('desc-input').value.trim();

                    // Enregistrer dans Firebase
                    await addDoc(collection(db, "signalements"), {
                        copro,
                        description,
                        employee,
                        images,
                        createdAt: new Date()
                    });

                    // Envoi notification ntfy
                    let message = `üö® Nouveau signalement de ${employee} sur ${copro}\n${description}`;

                    if (notif == false) {
                        if (images.length > 0 && images[0].url) {
                            message += `\nüì∏ ${images[0].url}`;
                        }

                        try {
                            await fetch("https://ntfy.sh/signalement-propre-eco", {
                                method: "POST",
                                body: message
                            });
                        } catch (ntfyError) {
                            console.error("Erreur notification ntfy:", ntfyError);
                        }
                    }

                } else if (typeSignal === 'consommable') {
                    const consomType = document.getElementById('consommable-type').value.trim();
                    const consomQuantite = parseInt(document.getElementById('consommable-quantite').value);

                    // Enregistrer dans Firebase
                    await addDoc(collection(db, "consommables"), {
                        copro,
                        type: consomType,
                        quantite: consomQuantite,
                        employee,
                        images,
                        facture: false,
                        createdAt: new Date()
                    });

                    // Envoi notification ntfy
                    let message = `üì¶ Consommable utilis√© par ${employee} sur ${copro}\n${consomType} (x${consomQuantite})`;

                    if (notif == false) {
                        if (images.length > 0 && images[0].url) {
                            message += `\nüì∏ ${images[0].url}`;
                        }

                        try {
                            await fetch("https://ntfy.sh/signalement-propre-eco", {
                                method: "POST",
                                body: message
                            });
                        } catch (ntfyError) {
                            console.error("Erreur notification ntfy:", ntfyError);
                        }
                    }
                }

                loading.classList.remove('active');
                loading.style.display = 'none';

                // Afficher le succ√®s
                const successOverlay = document.getElementById('successOverlay');
                successOverlay.style.display = 'flex';

                // R√©initialiser le formulaire
                form.reset();
                selectedFiles = [];
                compressedFiles = [];
                imagePreview.innerHTML = '';

                // Remettre la signature sauvegard√©e apr√®s reset
                if (savedSignature) {
                    signatureInput.value = savedSignature;
                }

                // Remettre sur "probl√®me" par d√©faut
                typeSignalement.value = 'probleme';
                problemeFields.style.display = 'block';
                consommableFields.style.display = 'none';
                descInput.setAttribute('required', 'required');
                consommableType.removeAttribute('required');
                consommableQuantite.removeAttribute('required');

                // Fermer le succ√®s apr√®s 3s
                setTimeout(() => {
                    successOverlay.style.display = 'none';
                }, 3000);

            } catch (err) {
                console.error("Erreur:", err);
                loading.classList.remove('active');
                loading.style.display = 'none';
                showStatus(`√¢¬ù≈í Erreur lors de l'envoi : ${err.message}`, "error");
            }
        });

        // Navigation mobile
        // Navigation mobile
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButton = document.querySelector('.nav-toggle');
            const menu = document.querySelector('.nav-menu');

            if (toggleButton && menu) {
                toggleButton.addEventListener('click', () => {
                    menu.classList.toggle('open');
                });

                // Fermer le menu en cliquant sur un lien
                document.querySelectorAll('.nav-menu a').forEach(link => {
                    link.addEventListener('click', () => {
                        menu.classList.remove('open');
                    });
                });
            }
        });
    </script>
    <script type="module" src="../js/announcements.js"></script>
    <script type="module">
        import { initNavigation, setActiveNavItem } from '../js/navbar.js';
        initNavigation();
        setActiveNavItem('signaler.html'); 
    </script>
</body>

</html>