<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Mes heures - Propre Eco</title>

    <!-- PWA Configuration -->
    <link rel="icon" type="image/png" href="../img/logo.png" />
    <link rel="apple-touch-icon" href="../img/logo.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="../img/logo.png" />
    <link rel="manifest" href="../manifest.json">

    <!-- PWA Métadonnées -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Propre Eco">
    <meta name="theme-color" content="#10B981">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <!-- Styles -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/index-specific.css">
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" href="../css/heures.css">
    <link rel="stylesheet" href="../css/modals.css">
    <link rel="stylesheet" href="../css/navbar.css">

    <!-- Scripts Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <button class="hamburger-btn" aria-label="Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>

            <a href="../index.html" class="logo">
                <img src="../img/logo.png" width="60px" alt="Logo Propre Eco">
                Propre Eco Assistant
            </a>

            <div class="header-spacer"></div>
        </div>
    </header>

    <div class="sidebar-overlay"></div>
    <nav class="sidebar-menu">
        <div class="sidebar-header">
            <img src="../img/logo.png" width="50px" alt="Logo">
            <h3>Propre Eco</h3>
            <button class="sidebar-close" aria-label="Fermer">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="sidebar-content">
            <div class="menu-section">
                <span class="menu-section-title">Navigation</span>
                <ul class="sidebar-nav">
                    <li>
                        <a href="../index.html">
                            <i class="fas fa-home"></i>
                            <span>Accueil</span>
                        </a>
                    </li>
                    <li>
                        <a href="signaler.html">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Signaler</span>
                        </a>
                    </li>
                    <li>
                        <a href="Feuilles.html">
                            <i class="fas fa-file-alt"></i>
                            <span>Feuilles</span>
                        </a>
                    </li>
                    <li>
                        <a href="Specifique.html">
                            <i class="fas fa-hard-hat"></i>
                            <span>Specifique</span>
                        </a>
                    </li>
                    <li>
                        <a href="pointeuse.html">
                            <i class="fas fa-clock"></i>
                            <span>Pointeuse</span>
                        </a>
                    </li>
                    <li>
                        <a href="devis.html">
                            <i class="fas fa-file-invoice"></i>
                            <span>Devis</span>
                        </a>
                    </li>
                    <li>
                        <a href="dashbord.html">
                            <i class="fas fa-columns"></i>
                            <span>Tableau de bord</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="loadingOverlay" class="loading-overlay" style="display:none">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Chargement...</p>
        </div>
    </div>

    <div class="container">


        <div class="user-info" style="margin-bottom: 2rem; justify-content: center;">
            <div class="user-avatar" id="userAvatar">?</div>
            <span id="userName">Employé</span>
        </div>

        <div class="section-card">
            <div
                style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                <strong style="color: #92400e;">Pensez à cliquer sur Enregistrer !</strong>
            </div>
            <div class="week-selector"><label for="weekInput" style="font-weight:600"><i class="fas fa-calendar"></i>
                    Semaine :</label><input type="week" id="weekInput" class="week-input"></div>
            <div class="table-wrapper">
                <table id="weeklyTable">
                    <thead>
                        <tr>
                            <th>Jour</th>
                            <th>Heures</th>
                            <th>Commentaires</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Lun</strong></td>
                            <td><input type="number" class="table-input hours" min="0" max="24" step="0.25"
                                    placeholder="0"></td>
                            <td><textarea class="table-input" placeholder="Commentaires..."></textarea></td>
                        </tr>
                        <tr>
                            <td><strong>Mar</strong></td>
                            <td><input type="number" class="table-input hours" min="0" max="24" step="0.25"
                                    placeholder="0"></td>
                            <td><textarea class="table-input" placeholder="Commentaires..."></textarea></td>
                        </tr>
                        <tr>
                            <td><strong>Mer</strong></td>
                            <td><input type="number" class="table-input hours" min="0" max="24" step="0.25"
                                    placeholder="0"></td>
                            <td><textarea class="table-input" placeholder="Commentaires..."></textarea></td>
                        </tr>
                        <tr>
                            <td><strong>Jeu</strong></td>
                            <td><input type="number" class="table-input hours" min="0" max="24" step="0.25"
                                    placeholder="0"></td>
                            <td><textarea class="table-input" placeholder="Commentaires..."></textarea></td>
                        </tr>
                        <tr>
                            <td><strong>Ven</strong></td>
                            <td><input type="number" class="table-input hours" min="0" max="24" step="0.25"
                                    placeholder="0"></td>
                            <td><textarea class="table-input" placeholder="Commentaires..."></textarea></td>
                        </tr>
                        <tr>
                            <td><strong>Sam</strong></td>
                            <td><input type="text" class="table-input hours" placeholder="0 = Repos"></td>
                            <td><textarea class="table-input" placeholder="CP = Congés payés "></textarea></td>
                        </tr>
                        <tr>
                            <td><strong>Dim</strong></td>
                            <td><input type="text" class="table-input hours" placeholder="0 = Repos"></td>
                            <td><textarea class="table-input" placeholder="CP = Congés payés "></textarea></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td><strong>TOTAL</strong></td>
                            <td class="total-value" id="totalWeeklyHours">0h</td>
                            <td></td>
                        </tr>
                        <tr class="total-row">
                            <td colspan="3" style="padding:.5rem"><label
                                    style="margin-right:.5rem;font-size:.9rem"><strong>KM :</strong></label><input
                                    type="number" class="table-input" id="kilometrage" min="0" placeholder="Kilomètres"
                                    style="max-width:120px;display:inline-block"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="section-actions"><button class="btn" onclick="saveWeeklyData()" id="saveWeeklyBtn"><i
                        class="fas fa-save"></i>Enregistrer</button><button class="btn btn-secondary"
                    onclick="resetWeeklyData()"><i class="fas fa-redo"></i>Réinitialiser</button></div>
        </div>
        <div class="section-card">
            <div class="section-header">
                <div class="section-icon"><i class="fas fa-hard-hat"></i></div>
                <h2 class="section-title">Chantiers spécifique</h2>
            </div>
            <div
                style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                <strong style="color: #92400e;">Pensez à cliquer sur Enregistrer !</strong>
            </div>

            <!-- Bouton pour afficher le formulaire -->
            <div style="text-align: center; margin-bottom: 1rem;" id="showFormBtn">
                <button class="btn btn-secondary" onclick="showProjectForm()">
                    <i class="fas fa-plus"></i> Ajouter un chantier
                </button>
            </div>

            <!-- Formulaire de saisie (masqué par défaut) -->
            <div id="projectFormContainer" style="display: none;">
                <div class="table-wrapper">
                    <table id="projectsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Chantier</th>
                                <th>Nombre d'employés</th>
                                <th>Equipe</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody"></tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="4"><strong>TOTAL</strong></td>
                                <td class="total-value" id="totalProjectsHours">0h</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="section-actions"><button class="btn btn-secondary" onclick="addProjectRow()"><i
                            class="fas fa-plus"></i>Ajouter</button><button class="btn" onclick="saveProjectsData()"
                        id="saveProjectsBtn"><i class="fas fa-save"></i>Enregistrer</button></div>
            </div>

            <!-- Tableau d'affichage des chantiers enregistrés -->
            <div id="savedProjectsDisplay" style="margin-top: 2rem; display: none;">
                <div
                    style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 1rem; border-radius: 12px 12px 0 0; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-list-check"></i>
                    <h3 style="margin: 0; font-size: 1.1rem;">Chantiers enregistrés cette semaine</h3>
                </div>
                <div
                    style="background: white; border: 2px solid var(--primary); border-top: none; border-radius: 0 0 12px 12px; padding: 1.5rem;">
                    <table id="savedProjectsTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--primary-light);">
                                <th
                                    style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--primary);">
                                    Date</th>
                                <th
                                    style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--primary);">
                                    Chantier</th>
                                <th
                                    style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--primary);">
                                    Nb employés</th>
                                <th
                                    style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--primary);">
                                    Équipe</th>
                                <th
                                    style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--primary);">
                                    Total</th>
                                <th
                                    style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--primary);">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="savedProjectsBody"></tbody>
                        <tfoot>
                            <tr style="background: var(--primary-light); font-weight: 700;">
                                <td colspan="5" style="padding: 1rem 0.75rem; border-top: 2px solid var(--primary);">
                                    TOTAL</td>
                                <td id="savedProjectsTotal"
                                    style="padding: 1rem 0.75rem; border-top: 2px solid var(--primary); color: var(--primary-dark); font-size: 1.1rem;">
                                    0h</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Modale rappel samedi -->
    <div id="samediRappelModal"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
        <div
            style="background:white; border-radius:16px; padding:2rem; max-width:360px; width:90%; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div
                style="background:linear-gradient(135deg,#f59e0b,#d97706); width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1rem;">
                <i class="fas fa-calendar-check" style="color:white; font-size:1.5rem;"></i>
            </div>
            <h3 style="color:#92400e; margin-bottom:1rem;">Rappel repos & congés</h3>
            <p style="color:#374151; line-height:1.6; margin-bottom:1.5rem;">
                N'oubliez pas de renseigner <strong>0</strong> si vous êtes en repos <strong>samedi et/ou
                    dimanche</strong>.<br><br>
                Pensez également à indiquer <strong>0</strong> & <strong>CP</strong> dans les commentaires lorsque vous
                êtes en congés payés.
            </p>
            <button onclick="closeSamediRappel()"
                style="background:linear-gradient(135deg,#f59e0b,#d97706); color:white; border:none; padding:0.75rem 2rem; border-radius:8px; font-size:1rem; font-weight:600; cursor:pointer; width:100%;">
                <i class="fas fa-check"></i> Compris
            </button>
        </div>
    </div>

    <!-- Modale interdiction remplissage futur -->
    <div id="futurInterdictionModal"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
        <div
            style="background:white; border-radius:16px; padding:2rem; max-width:360px; width:90%; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div
                style="background:linear-gradient(135deg,#ef4444,#dc2626); width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1rem;">
                <i class="fas fa-ban" style="color:white; font-size:1.5rem;"></i>
            </div>
            <h3 style="color:#991b1b; margin-bottom:1rem;">Remplissage interdit</h3>
            <p style="color:#374151; line-height:1.6; margin-bottom:1.5rem;">
                <strong>Il est strictement interdit de remplir ses heures à l'avance.</strong><br><br>
                Les heures doivent être renseignées chaque jour.
            </p>
            <button onclick="closeFuturInterdiction()"
                style="background:linear-gradient(135deg,#ef4444,#dc2626); color:white; border:none; padding:0.75rem 2rem; border-radius:8px; font-size:1rem; font-weight:600; cursor:pointer; width:100%;">
                <i class="fas fa-times"></i> Fermer
            </button>
        </div>
    </div>
    <footer class="app-footer">
        Developed with <span style="color: #ff6b6b;">❤️</span> by Ashborn
    </footer>
    <script>
        // Menu toggle
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButton = document.querySelector('.nav-toggle');
            const menu = document.querySelector('.nav-menu');

            if (toggleButton && menu) {
                toggleButton.addEventListener('click', () => {
                    menu.classList.toggle('open');
                });

                document.querySelectorAll('.nav-menu a').forEach(link => {
                    link.addEventListener('click', () => {
                        menu.classList.remove('open');
                    });
                });
            }
        });

        // Firebase et fonctionnalités existantes
        const firebaseConfig = { apiKey: "AIzaSyBzXEN0e-4dgh9NVVF7JGzpKtJrPnuzo0Y", authDomain: "copro-256d7.firebaseapp.com", projectId: "copro-256d7", storageBucket: "copro-256d7.appspot.com", messagingSenderId: "665588381388", appId: "1:665588381388:web:a0567533ff1a62407db469", measurementId: "G-Y7YNZDDCTD" };
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('✅ Firestore initialisé')
        } catch (error) {
            console.error('❌ Erreur:', error);
            showNotification('Erreur de connexion', 'error')
        }

        let currentEmployeeId = null, currentEmployeeName = null, currentWeek = null, projectRowCounter = 0;
        const employeeNames = { 'dylan': 'Dylan', 'oceane': 'Océane', 'samuel': 'Samuel', 'jeremie': 'Jérémie', 'carlos': 'Carlos', 'sandra': 'Sandra', 'manon': 'Manon', 'stephane': 'Stéphane', 'isabelle': 'Isabelle', 'caroline': 'Caroline', 'nadjet': 'Nadjet', 'remy': 'Rémy', 'maxime': 'Maxime', 'shana': 'Shana' };
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            currentEmployeeId = urlParams.get('employee');
            if (!currentEmployeeId) {
                showNotification('Employé non identifié', 'error');
                setTimeout(() => window.location.href = 'pointeuse.html', 2000);
                return
            }
            currentEmployeeName = employeeNames[currentEmployeeId] || 'Employé';
            document.getElementById('userName').textContent = currentEmployeeName;
            document.getElementById('userAvatar').textContent = getInitials(currentEmployeeName);

            // Vérifier si l'utilisateur a une session sauvegardée et afficher le bouton de déconnexion
            checkAndShowLogoutButton();

            const today = new Date();
            const weekInput = document.getElementById('weekInput');
            weekInput.value = getWeekString(today);
            currentWeek = weekInput.value;

            // Charger automatiquement les données de la semaine
            loadWeekDataAuto();
            loadProjectsData();

            // Vérifier si samedi → afficher rappel
            checkSamediRappel();

            // Ajouter un listener pour charger automatiquement quand on change la semaine
            weekInput.addEventListener('change', function () {
                currentWeek = this.value;
                loadWeekDataAuto();
                checkSamediRappel();
            });

            // Validation et calcul pour les inputs d'heures
            document.querySelectorAll('#weeklyTable .hours').forEach(input => {
                input.addEventListener('input', calculateWeeklyTotal);

                // Valider que c'est un multiple de 0.25
                input.addEventListener('blur', function () {
                    const value = parseFloat(this.value);
                    if (!isNaN(value)) {
                        // Arrondir au multiple de 0.25 le plus proche
                        const rounded = Math.round(value * 4) / 4;
                        if (rounded !== value) {
                            this.value = rounded;
                            calculateWeeklyTotal();
                            showNotification(`Valeur arrondie à ${rounded}h (multiples de 0.25 uniquement)`, 'info');
                        }
                    }
                });
            })
        });

        // Vérifier si une session est sauvegardée pour cet employé
        function checkAndShowLogoutButton() {
            const SAVED_SESSION_KEY = "savedEmployeeSession";
            const savedSession = localStorage.getItem(SAVED_SESSION_KEY);

            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    // Si la session correspond à l'employé actuel, afficher le bouton
                    if (sessionData.employeeId === currentEmployeeId) {
                        const logoutBtn = document.getElementById('logoutBtn');
                        if (logoutBtn) {
                            logoutBtn.style.display = 'flex';
                            logoutBtn.style.alignItems = 'center';
                            logoutBtn.style.gap = '0.5rem';
                        }
                    }
                } catch (error) {
                    console.error('Erreur lecture session:', error);
                }
            }
        }

        // Fonction de déconnexion
        function logoutSession() {
            const SAVED_SESSION_KEY = "savedEmployeeSession";

            if (confirm('Êtes-vous sûr de vouloir désactiver la connexion automatique ?')) {
                localStorage.removeItem(SAVED_SESSION_KEY);
                showNotification('Connexion automatique désactivée', 'success');

                // Masquer le bouton
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.style.display = 'none';
                }

                // Rediriger vers la pointeuse après 1.5 secondes
                setTimeout(() => {
                    window.location.href = 'pointeuse.html';
                }, 1500);
            }
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase()
        }

        function getWeekString(date) {
            const year = date.getFullYear();
            const weekNum = getWeekNumber(date);
            return `${year}-W${weekNum.toString().padStart(2, '0')}`
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7)
        }

        function showLoading(show = true) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            const icons = { success: 'fas fa-check-circle', warning: 'fas fa-exclamation-triangle', error: 'fas fa-times-circle', info: 'fas fa-info-circle' };
            const colors = { success: 'linear-gradient(135deg, #10b981, #059669)', warning: 'linear-gradient(135deg, #f59e0b, #d97706)', error: 'linear-gradient(135deg, #ef4444, #dc2626)', info: 'linear-gradient(135deg, #3b82f6, #2563eb)' };
            notification.style.background = colors[type] || colors.info;
            notification.innerHTML = `<i class="${icons[type] || icons.info}"></i><span>${message}</span>`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
                setTimeout(() => notification.remove(), 300)
            }, 3000)
        }

        function calculateWeeklyTotal() {
            const hoursInputs = document.querySelectorAll('#weeklyTable .hours');
            let total = 0;
            hoursInputs.forEach(input => {
                const value = input.value.trim();
                if (value && value.toUpperCase() !== 'R') {
                    const hours = parseFloat(value);
                    if (!isNaN(hours)) {
                        // Arrondir à 2 décimales pour éviter les erreurs de précision JavaScript
                        total += Math.round(hours * 100) / 100;
                    }
                }
            });
            // Arrondir le total final et formater proprement
            const roundedTotal = Math.round(total * 100) / 100;
            // Afficher avec 2 décimales si nécessaire, sinon avec 1
            const displayTotal = roundedTotal % 1 === 0 ? roundedTotal.toFixed(0) :
                (roundedTotal * 4) % 1 === 0 ? roundedTotal.toFixed(2) :
                    roundedTotal.toFixed(1);
            document.getElementById('totalWeeklyHours').textContent = displayTotal + 'h';
            return roundedTotal;
        }

        async function loadWeekData() {
            const selectedWeek = document.getElementById('weekInput').value;
            if (!selectedWeek) {
                showNotification('Sélectionnez une semaine', 'warning');
                return
            }
            currentWeek = selectedWeek;
            showLoading(true);
            try {
                const docRef = db.collection('employees').doc(currentEmployeeId).collection('weeks').doc(currentWeek);
                const doc = await docRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    if (data.days) {
                        data.days.forEach((dayData, index) => {
                            const rows = document.querySelectorAll('#weeklyTable tbody tr');
                            if (rows[index]) {
                                rows[index].querySelector('.hours').value = dayData.hours || '';
                                rows[index].querySelector('textarea').value = dayData.comments || ''
                            }
                        })
                    }
                    document.getElementById('kilometrage').value = data.kilometrage || '';
                    calculateWeeklyTotal();
                    showNotification('Données chargées', 'success')
                } else {
                    document.querySelectorAll('#weeklyTable .hours').forEach(input => input.value = '');
                    document.querySelectorAll('#weeklyTable textarea').forEach(textarea => textarea.value = '');
                    document.getElementById('kilometrage').value = '';
                    calculateWeeklyTotal();
                    showNotification('Aucune donnée pour cette semaine', 'info')
                }
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur lors du chargement', 'error')
            } finally {
                showLoading(false)
            }
        }

        async function loadWeekDataAuto() {
            if (!currentWeek) {
                return;
            }
            showLoading(true);
            try {
                const docRef = db.collection('employees').doc(currentEmployeeId).collection('weeks').doc(currentWeek);
                const doc = await docRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    if (data.days) {
                        data.days.forEach((dayData, index) => {
                            const rows = document.querySelectorAll('#weeklyTable tbody tr');
                            if (rows[index]) {
                                rows[index].querySelector('.hours').value = dayData.hours || '';
                                rows[index].querySelector('textarea').value = dayData.comments || '';
                            }
                        });
                    }
                    document.getElementById('kilometrage').value = data.kilometrage || '';

                    // Charger les chantiers spécifiques de cette semaine
                    if (data.projects && data.projects.length > 0) {
                        displaySavedProjects(data.projects);
                    } else {
                        hideSavedProjectsDisplay();
                    }
                } else {
                    // Aucune donnée pour cette semaine, réinitialiser les champs
                    document.querySelectorAll('#weeklyTable .hours').forEach(input => input.value = '');
                    document.querySelectorAll('#weeklyTable textarea').forEach(textarea => textarea.value = '');
                    document.getElementById('kilometrage').value = '';
                    hideSavedProjectsDisplay();
                }
                calculateWeeklyTotal();
            } catch (error) {
                console.error('Erreur:', error);
            } finally {
                showLoading(false);
            }
        }
        function checkSamediRappel() {
            const today = new Date();
            if (today.getDay() === 6) {
                const key = `samedi_rappel_${today.toISOString().split('T')[0]}`;
                if (!sessionStorage.getItem(key)) {
                    setTimeout(() => {
                        const modal = document.getElementById('samediRappelModal');
                        modal.style.display = 'flex';
                    }, 800);
                }
            }
        }

        function closeSamediRappel() {
            document.getElementById('samediRappelModal').style.display = 'none';
            const today = new Date();
            const key = `samedi_rappel_${today.toISOString().split('T')[0]}`;
            sessionStorage.setItem(key, '1');
        }

        function closeFuturInterdiction() {
            document.getElementById('futurInterdictionModal').style.display = 'none';
        }

        // Retourne true si la semaine sélectionnée contient des jours FUTURS (après demain)
        function getWeekStartDate(weekString) {
            const [year, week] = weekString.split('-W').map(Number);
            const jan4 = new Date(year, 0, 4); // Local, pas UTC
            const dayOfWeek = jan4.getDay() || 7;
            const monday = new Date(jan4);
            monday.setDate(jan4.getDate() - dayOfWeek + 1 + (week - 1) * 7);
            monday.setHours(0, 0, 0, 0); // Minuit local → plus de décalage
            return monday;
        }



        // ✅ CORRECTION 1 : Ajouter { merge: true } pour ne pas écraser les chantiers
        async function saveWeeklyData() {
            if (!currentWeek) {
                showNotification('Sélectionnez une semaine', 'warning');
                return;
            }

            // Bloquer si un jour non encore passé contient des heures
            const today = new Date();
            today.setHours(23, 59, 59, 999);

            const [year, weekNum] = currentWeek.split('-W').map(Number);
            const rows = document.querySelectorAll('#weeklyTable tbody tr');
            let futurDetecte = false;

            rows.forEach((row, index) => {
                const hours = row.querySelector('.hours').value.trim();
                if (hours === '' || parseFloat(hours) === 0) return;
                 const jourReel = new Date(getWeekStartDate(currentWeek));
                jourReel.setDate(jourReel.getDate() + index);

                if (jourReel > today) {
                    futurDetecte = true;
                }
            });
            if (futurDetecte) {
                document.getElementById('futurInterdictionModal').style.display = 'flex';
                return;
            }

            const data = { days: [], kilometrage: document.getElementById('kilometrage').value, lastUpdate: firebase.firestore.FieldValue.serverTimestamp() };
            document.querySelectorAll('#weeklyTable tbody tr').forEach((row, index) => {
                const day = row.querySelector('td strong').textContent;
                const hours = row.querySelector('.hours').value;
                const comments = row.querySelector('textarea').value;
                data.days.push({ day: day, hours: hours, comments: comments })
            });
            showLoading(true);
            const saveBtn = document.getElementById('saveWeeklyBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
            try {
                await db.collection('employees').doc(currentEmployeeId).collection('weeks').doc(currentWeek).set(data, { merge: true });
                showNotification('Données enregistrées!', 'success')
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur lors de l\'enregistrement', 'error')
            } finally {
                showLoading(false);
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer'
            }
        }
        function resetWeeklyData() {
            if (confirm('Effacer toutes les données?')) {
                document.querySelectorAll('#weeklyTable .hours').forEach(input => input.value = '');
                document.querySelectorAll('#weeklyTable textarea').forEach(textarea => textarea.value = '');
                document.getElementById('kilometrage').value = '';
                calculateWeeklyTotal();
                showNotification('Données réinitialisées', 'info')
            }
        }

        function addProjectRow() {
            const tbody = document.getElementById('projectsTableBody');
            const row = document.createElement('tr');
            row.dataset.rowId = projectRowCounter++;
            row.innerHTML = `<td data-label="Date"><input type="date" class="table-input" data-field="date"></td><td data-label="Chantier"><input type="text" class="table-input" data-field="name" placeholder="Nom"></td><td data-label="Nombre d'employés"><input type="number" class="table-input" data-field="employees" min="1" placeholder="1"></td><td data-label="Equipe"><input type="text" class="table-input" data-field="team" placeholder="Equipe"></td><td data-label="Total"><input type="text" class="table-input" data-field="totalHours" placeholder="Total" style="font-weight:700;text-align:center"></td><td style="text-align:center;padding:.2rem"><button class="btn btn-danger" onclick="removeProjectRow(this)" style="padding:.5rem 1rem;font-size:.85rem;min-height:44px"><i class="fas fa-trash"></i> Supprimer</button></td>`;
            tbody.appendChild(row);
            row.querySelector('[data-field="totalHours"]').addEventListener('input', calculateProjectsTotal);
        }

        function calculateProjectsTotal() {
            const rows = document.querySelectorAll('#projectsTableBody tr');
            let grandTotal = 0;
            rows.forEach(row => {
                const totalText = row.querySelector('[data-field="totalHours"]').value;
                if (totalText) {
                    const total = parseFloat(totalText.replace('h', '').replace(',', '.').trim());
                    if (!isNaN(total)) {
                        // Arrondir chaque valeur à 2 décimales pour éviter les erreurs de précision
                        grandTotal += Math.round(total * 100) / 100;
                    }
                }
            });
            // Arrondir le total final
            const roundedTotal = Math.round(grandTotal * 100) / 100;
            // Affichage intelligent
            const displayTotal = roundedTotal % 1 === 0 ? roundedTotal.toFixed(0) :
                (roundedTotal * 4) % 1 === 0 ? roundedTotal.toFixed(2) :
                    roundedTotal.toFixed(1);
            document.getElementById('totalProjectsHours').textContent = displayTotal + 'h';
        }

        function removeProjectRow(button) {
            if (confirm('Supprimer ce chantier?')) {
                button.closest('tr').remove();
                calculateProjectsTotal();
                showNotification('Chantier supprimé', 'info')
            }
        }

        // ✅ CORRECTION 2 : Améliorer la validation et utiliser merge: true
        async function saveProjectsData() {
            const newData = [];
            const rows = document.querySelectorAll('#projectsTableBody tr');
            rows.forEach(row => {
                const projectData = {
                    date: row.querySelector('[data-field="date"]').value,
                    name: row.querySelector('[data-field="name"]').value.trim(),
                    employees: row.querySelector('[data-field="employees"]').value.trim(),
                    team: row.querySelector('[data-field="team"]').value.trim(),
                    totalHours: row.querySelector('[data-field="totalHours"]').value.trim()
                };
                // ✅ CORRECTION : Vérifier que le nom n'est pas vide
                if (projectData.name && projectData.name !== '') {
                    newData.push(projectData)
                }
            });

            if (newData.length === 0) {
                showNotification('Aucun chantier à enregistrer', 'warning');
                return;
            }

            // Vérifier qu'une semaine est sélectionnée
            const selectedWeek = document.getElementById('weekInput').value;
            if (!selectedWeek) {
                showNotification('Veuillez sélectionner une semaine', 'warning');
                return;
            }

            showLoading(true);
            const saveBtn = document.getElementById('saveProjectsBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
            try {
                // Sauvegarder les chantiers dans la semaine en cours
                const weekRef = db.collection('employees').doc(currentEmployeeId).collection('weeks').doc(selectedWeek);
                const weekDoc = await weekRef.get();

                let existingProjects = [];
                if (weekDoc.exists && weekDoc.data().projects) {
                    existingProjects = weekDoc.data().projects;
                }

                // Si on est en mode édition, remplacer le chantier à l'index stocké
                let allProjects;
                if (typeof window.editingProjectIndex !== 'undefined') {
                    existingProjects[window.editingProjectIndex] = newData[0];
                    delete window.editingProjectIndex;
                    allProjects = existingProjects;
                } else {
                    // Sinon, ajouter les nouveaux chantiers aux existants
                    allProjects = [...existingProjects, ...newData];
                }

                // ✅ CORRECTION : Toujours utiliser merge: true
                await weekRef.set({
                    projects: allProjects,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                showNotification('Chantiers enregistrés pour la semaine ' + selectedWeek + '!', 'success');
                displaySavedProjects(allProjects);
                // Vider le tableau de saisie
                document.getElementById('projectsTableBody').innerHTML = '';
                addProjectRow();
                calculateProjectsTotal();
                // Masquer le formulaire
                hideProjectForm();
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur lors de l\'enregistrement', 'error')
            } finally {
                showLoading(false);
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer'
            }
        }

        async function loadProjectsData() {
            const selectedWeek = document.getElementById('weekInput').value;
            if (!selectedWeek) {
                hideSavedProjectsDisplay();
                return;
            }

            showLoading(true);
            try {
                const weekRef = db.collection('employees').doc(currentEmployeeId).collection('weeks').doc(selectedWeek);
                const weekDoc = await weekRef.get();
                if (weekDoc.exists && weekDoc.data().projects) {
                    const projects = weekDoc.data().projects;
                    if (projects.length > 0) {
                        displaySavedProjects(projects);
                    } else {
                        hideSavedProjectsDisplay();
                    }
                } else {
                    hideSavedProjectsDisplay();
                }
                // Toujours avoir une ligne vide pour saisie
                document.getElementById('projectsTableBody').innerHTML = '';
                addProjectRow();
                calculateProjectsTotal();
            } catch (error) {
                console.error('Erreur:', error);
                hideSavedProjectsDisplay();
                document.getElementById('projectsTableBody').innerHTML = '';
                addProjectRow();
            } finally {
                showLoading(false)
            }
        }

        function displaySavedProjects(projectsData) {
            const display = document.getElementById('savedProjectsDisplay');
            const tbody = document.getElementById('savedProjectsBody');
            const totalCell = document.getElementById('savedProjectsTotal');

            if (!projectsData || projectsData.length === 0) {
                display.style.display = 'none';
                return;
            }

            tbody.innerHTML = '';
            let total = 0;

            projectsData.forEach((project, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #e5e7eb';
                if (index % 2 === 0) row.style.background = '#f8fafc';

                const date = new Date(project.date).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
                const totalNum = parseFloat(project.totalHours?.replace('h', '').replace(',', '.')) || 0;
                total += totalNum;

                row.innerHTML = `
                    <td data-label="Date" style="padding: 0.75rem;">${date}</td>
                    <td data-label="Chantier" style="padding: 0.75rem;"><strong>${project.name || '-'}</strong></td>
                    <td data-label="Nb employés" style="padding: 0.75rem;">${project.employees || '-'}</td>
                    <td data-label="Équipe" style="padding: 0.75rem;">${project.team || '-'}</td>
                    <td data-label="Total" style="padding: 0.75rem;"><strong>${project.totalHours || '0h'}</strong></td>
                    <td data-label="Actions" style="padding: 0.75rem;">
                        <button onclick="editProject(${index})" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; margin-right: 0.5rem; font-size: 0.85rem;">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button onclick="deleteProject(${index})" style="background: #ef4444; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            totalCell.textContent = total.toFixed(1) + 'h';
            display.style.display = 'block';
        }

        function hideSavedProjectsDisplay() {
            document.getElementById('savedProjectsDisplay').style.display = 'none';
        }

        function showProjectForm() {
            document.getElementById('projectFormContainer').style.display = 'block';
            document.getElementById('showFormBtn').style.display = 'none';
        }

        function hideProjectForm() {
            document.getElementById('projectFormContainer').style.display = 'none';
            document.getElementById('showFormBtn').style.display = 'block';
        }

        // ✅ CORRECTION 3 : Ne pas supprimer immédiatement le chantier lors de l'édition
        async function editProject(index) {
            const selectedWeek = document.getElementById('weekInput').value;
            if (!selectedWeek) {
                showNotification('Veuillez sélectionner une semaine', 'warning');
                return;
            }

            showLoading(true);
            try {
                const weekRef = db.collection('employees').doc(currentEmployeeId).collection('weeks').doc(selectedWeek);
                const weekDoc = await weekRef.get();

                if (weekDoc.exists && weekDoc.data().projects) {
                    const projects = weekDoc.data().projects;
                    const project = projects[index];

                    // ✅ CORRECTION : Stocker l'index pour la sauvegarde ultérieure au lieu de supprimer
                    window.editingProjectIndex = index;

                    // Afficher le formulaire
                    showProjectForm();

                    // Remplir le formulaire avec les données du chantier
                    const tbody = document.getElementById('projectsTableBody');
                    tbody.innerHTML = '';
                    addProjectRow();

                    const row = tbody.querySelector('tr');
                    row.querySelector('[data-field="date"]').value = project.date || '';
                    row.querySelector('[data-field="name"]').value = project.name || '';
                    row.querySelector('[data-field="employees"]').value = project.employees || '';
                    row.querySelector('[data-field="team"]').value = project.team || '';
                    row.querySelector('[data-field="totalHours"]').value = project.totalHours || '';

                    calculateProjectsTotal();
                }
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur lors du chargement', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteProject(index) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce chantier ?')) {
                return;
            }

            const selectedWeek = document.getElementById('weekInput').value;
            if (!selectedWeek) {
                showNotification('Veuillez sélectionner une semaine', 'warning');
                return;
            }

            showLoading(true);
            try {
                const weekRef = db.collection('employees').doc(currentEmployeeId).collection('weeks').doc(selectedWeek);
                const weekDoc = await weekRef.get();

                if (weekDoc.exists && weekDoc.data().projects) {
                    const projects = weekDoc.data().projects;
                    projects.splice(index, 1);

                    // ✅ Utiliser merge: true également ici
                    await weekRef.set({ projects: projects }, { merge: true });
                    showNotification('Chantier supprimé !', 'success');
                    displaySavedProjects(projects);
                }
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur lors de la suppression', 'error');
            } finally {
                showLoading(false);
            }
        }
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('../service-worker.js')
                .then(reg => console.log('✅ Service Worker enregistré', reg))
                .catch(err => console.error('❌ Erreur Service Worker', err));
        }
    </script>
    <script type="module" src="../js/announcements.js"></script>
    <script>
        // Vérifier et afficher les annonces au chargement
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof initAnnouncementsPanel === 'function') {
                initAnnouncementsPanel();
            }
        });
    </script>
    <script type="module" src="../js/announcements.js"></script>
    <script type="module">
        import { initNavigation, setActiveNavItem } from '../js/navbar.js';
        initNavigation();
        setActiveNavItem('NOM_DU_FICHIER.html'); 
    </script>
</body>

</html>